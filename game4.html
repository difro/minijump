<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìˆ²ì—ì„œ ì‹œì‘í•˜ëŠ” ì í”„ ê²Œì„</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #7ec850;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: linear-gradient(to top, #4e944f 60%, #a3de83 100%);
    }
    #inventory {
      position: absolute;
      left: 10px;
      top: 10px;
      background: rgba(255,255,255,0.8);
      padding: 8px 16px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 18px;
      z-index: 10;
      display: none;
      min-width: 120px;
    }
    #inventory.show {
      display: block;
    }
  </style>
</head>
<body>
  <div id="inventory"></div>
  <canvas id="gameCanvas" width="600" height="400"></canvas>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const inventoryDiv = document.getElementById('inventory');

    // ë§µ ìƒíƒœ: 'forest', 'forest2', 'forest3', 'village', 'caveEntrance', 'cave'
    let currentMap = 'forest';

    // ë‚˜ë¬´ ë°ì´í„°
    const trees = [];
    for (let i = 0; i < 6; i++) {
      trees.push({
        x: 60 + i * 90,
        y: 270,
        width: 20,
        height: 80,
        radius: 35,
        chopped: false,
        chopCount: 0
      });
    }

    // ìˆ²2 ë°ì´í„° (ì‘ì€ ì—°ëª»)
    const pond = { x: 320, y: 340, w: 120, h: 30 };

    // ìˆ²3 ë°ì´í„° (í° ë°”ìœ„ì™€ ê½ƒ)
    const bigRock = { x: 400, y: 320, r: 35 };
    const flowers = [
      { x: 120, y: 355, color: "#ff69b4" },
      { x: 180, y: 360, color: "#ffd700" },
      { x: 220, y: 358, color: "#87ceeb" },
      { x: 300, y: 362, color: "#ff69b4" }
    ];

    // ë™êµ´ ì…êµ¬ ìœ„ì¹˜ ë° ëŒë§¹ì´ ë°ì´í„°
    const caveEntrance = { x: 400, y: 220, width: 120, height: 130 };
    const stones = [
      { x: 420, y: 340, r: 13 },
      { x: 470, y: 355, r: 10 },
      { x: 510, y: 345, r: 8 },
      { x: 560, y: 350, r: 12 },
      { x: 440, y: 360, r: 7 }
    ];

    // ë™êµ´ ë‚´ë¶€ ëŒë§¹ì´ ë°ì´í„°
    const caveStones = [
      { x: 80, y: 340, r: 10 },
      { x: 150, y: 355, r: 8 },
      { x: 200, y: 345, r: 12 },
      { x: 260, y: 350, r: 9 },
      { x: 320, y: 360, r: 7 },
      { x: 380, y: 355, r: 11 },
      { x: 440, y: 340, r: 10 },
      { x: 500, y: 350, r: 13 },
      { x: 560, y: 355, r: 8 }
    ];

    // ì² ê´‘ì„ ë°ì´í„° (ë™êµ´ ì§€ì—­)
    const irons = [
      { x: 120, y: 320, r: 16, mined: false },
      { x: 250, y: 340, r: 13, mined: false },
      { x: 400, y: 330, r: 18, mined: false }
    ];

    // ë¬´ë„ˆì§„ ë§ˆì„ ë°ì´í„°
    const ruins = [
      { x: 120, y: 320, w: 60, h: 40 },
      { x: 250, y: 300, w: 80, h: 60 },
      { x: 400, y: 310, w: 70, h: 50 }
    ];
    // ì¶”ê°€: ì“°ëŸ¬ì§„ ê¸°ë‘¥, ì”í•´, ë¶ˆíƒ€ëŠ” ì”ë¶ˆ, ì¡ì´ˆ, ë‚˜ë¬´ ê·¸ë£¨í„°ê¸°, ë°”ë‹¥ ê¸ˆ
    const fallenPillars = [
      { x: 180, y: 360, w: 40, h: 10, angle: -0.2 },
      { x: 350, y: 370, w: 50, h: 12, angle: 0.3 }
    ];
    const debris = [
      { x: 160, y: 355, r: 7 },
      { x: 290, y: 345, r: 10 },
      { x: 470, y: 360, r: 8 }
    ];
    const fires = [
      { x: 210, y: 350 },
      { x: 430, y: 355 }
    ];
    const stumps = [
      { x: 520, y: 360, r: 12 },
      { x: 80, y: 362, r: 10 }
    ];
    const cracks = [
      { x1: 140, y1: 370, x2: 170, y2: 390 },
      { x1: 300, y1: 370, x2: 320, y2: 390 },
      { x1: 500, y1: 370, x2: 540, y2: 390 }
    ];

    // í”Œë ˆì´ì–´
    const player = {
      x: 100,
      y: 300,
      width: 30,
      height: 30,
      color: "#ffcc00",
      vy: 0,
      jumpPower: -12,
      gravity: 0.6,
      onGround: false,
      speed: 3,
      hp: 100,
      maxHp: 100,
      attack: 0 // ê²€ ì¥ì°© ì‹œ 3.5
    };

    let hasSword = false;
    let gameOver = false; // ê²Œì„ì˜¤ë²„ ìƒíƒœ ë³€ìˆ˜

    // ì¥ ëª¬ìŠ¤í„° ë°ì´í„°
    const rats = [];
    function spawnRat() {
      rats.push({
        x: 100 + Math.random() * 400,
        y: 320,
        w: 28,
        h: 18,
        hp: 15,
        maxHp: 15,
        attack: 5,
        alive: true,
        dir: Math.random() < 0.5 ? 1 : -1,
        hitTimer: 0
      });
    }
    // ì²˜ìŒ ë§ˆì„ ì§„ì… ì‹œ 1ë§ˆë¦¬
    let villageEntered = false;
    let ratSpawnTimer = 0;

    function drawForest() {
      // ë•…
      ctx.fillStyle = "#3e683a";
      ctx.fillRect(0, 350, 600, 50);
      // ë‚˜ë¬´ ì—¬ëŸ¬ ê·¸ë¦¬ê¸°
      for (const tree of trees) {
        if (tree.chopped) continue;
        // ë‚˜ë¬´ ì¤„ê¸°
        ctx.fillStyle = "#8d5524";
        ctx.fillRect(tree.x, tree.y, tree.width, tree.height);
        // ë‚˜ë¬´ ì
        ctx.beginPath();
        ctx.arc(tree.x + tree.width/2, tree.y, tree.radius, Math.PI, 2 * Math.PI);
        ctx.fillStyle = "#2e8b57";
        ctx.fill();
      }
    }

    function drawForest2() {
      // ë•…
      ctx.fillStyle = "#3e683a";
      ctx.fillRect(0, 350, 600, 50);
      // ì—°ëª»
      ctx.save();
      ctx.fillStyle = "#4fc3f7";
      ctx.beginPath();
      ctx.ellipse(pond.x + pond.w/2, pond.y + pond.h/2, pond.w/2, pond.h/2, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
      // ë‚˜ë¬´ (ì ê²Œ)
      for (let i = 0; i < 3; i++) {
        let x = 80 + i * 180;
        ctx.fillStyle = "#8d5524";
        ctx.fillRect(x, 270, 20, 80);
        ctx.beginPath();
        ctx.arc(x + 10, 270, 35, Math.PI, 2 * Math.PI);
        ctx.fillStyle = "#388e3c";
        ctx.fill();
      }
      // ì—°ëª» í…ìŠ¤íŠ¸
      ctx.save();
      ctx.font = "bold 20px sans-serif";
      ctx.fillStyle = "#fff";
      ctx.fillText("ì‘ì€ ì—°ëª»", pond.x + 10, pond.y - 10);
      ctx.restore();
    }

    function drawForest3() {
      // ë•…
      ctx.fillStyle = "#3e683a";
      ctx.fillRect(0, 350, 600, 50);
      // í° ë°”ìœ„
      ctx.save();
      ctx.beginPath();
      ctx.arc(bigRock.x, bigRock.y, bigRock.r, 0, Math.PI * 2);
      ctx.fillStyle = "#888";
      ctx.fill();
      ctx.restore();
      // ê½ƒ
      for (const f of flowers) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(f.x, f.y, 6, 0, Math.PI * 2);
        ctx.fillStyle = f.color;
        ctx.fill();
        ctx.restore();
      }
      // ë‚˜ë¬´ (1ê°œ)
      ctx.fillStyle = "#8d5524";
      ctx.fillRect(520, 270, 20, 80);
      ctx.beginPath();
      ctx.arc(530, 270, 35, Math.PI, 2 * Math.PI);
      ctx.fillStyle = "#2e8b57";
      ctx.fill();
      // ë°”ìœ„ í…ìŠ¤íŠ¸
      ctx.save();
      ctx.font = "bold 20px sans-serif";
      ctx.fillStyle = "#fff";
      ctx.fillText("í° ë°”ìœ„ì™€ ê½ƒ", bigRock.x - 40, bigRock.y - 50);
      ctx.restore();
    }

    function drawVillage() {
      // ë•…
      ctx.fillStyle = "#b2a27a";
      ctx.fillRect(0, 350, 600, 50);

      // íí—ˆ ê±´ë¬¼
      for (const ruin of ruins) {
        ctx.save();
        ctx.fillStyle = "#888";
        ctx.fillRect(ruin.x, ruin.y, ruin.w, ruin.h);
        ctx.strokeStyle = "#555";
        ctx.lineWidth = 3;
        ctx.strokeRect(ruin.x, ruin.y, ruin.w, ruin.h);
        ctx.restore();
      }

      // ì“°ëŸ¬ì§„ ê¸°ë‘¥
      for (const p of fallenPillars) {
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle);
        ctx.fillStyle = "#7a5c3e";
        ctx.fillRect(0, 0, p.w, p.h);
        ctx.restore();
      }

      // ì”í•´(ëŒ)
      for (const d of debris) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
        ctx.fillStyle = "#aaa";
        ctx.fill();
        ctx.restore();
      }

      // ë¶ˆíƒ€ëŠ” ì”ë¶ˆ
      for (const f of fires) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(f.x, f.y, 10, 0, Math.PI, true);
        ctx.fillStyle = "#222";
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(f.x - 5, f.y);
        ctx.lineTo(f.x, f.y - 15);
        ctx.lineTo(f.x + 5, f.y);
        ctx.closePath();
        ctx.fillStyle = "#ff9800";
        ctx.fill();
        ctx.restore();
      }

      // ë‚˜ë¬´ ê·¸ë£¨í„°ê¸°
      for (const s of stumps) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fillStyle = "#8d5524";
        ctx.fill();
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r - 4, 0, Math.PI * 2);
        ctx.fillStyle = "#c69c6d";
        ctx.fill();
        ctx.restore();
      }

      // ë°”ë‹¥ ê¸ˆ
      for (const c of cracks) {
        ctx.save();
        ctx.strokeStyle = "#6d4c2c";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(c.x1, c.y1);
        ctx.lineTo(c.x2, c.y2);
        ctx.stroke();
        ctx.restore();
      }

      // ì¡ì´ˆ
      for (let i = 0; i < 10; i++) {
        ctx.save();
        ctx.strokeStyle = "#4e944f";
        ctx.beginPath();
        let gx = 50 + i * 50 + Math.random() * 10;
        ctx.moveTo(gx, 350);
        ctx.lineTo(gx + Math.random() * 10 - 5, 340 + Math.random() * 10);
        ctx.stroke();
        ctx.restore();
      }

      // ì¥ ê·¸ë¦¬ê¸°
      for (const rat of rats) {
        if (!rat.alive) continue;
        ctx.save();
        ctx.fillStyle = "#888";
        ctx.beginPath();
        ctx.ellipse(rat.x + rat.w/2, rat.y + rat.h/2, rat.w/2, rat.h/2, 0, 0, Math.PI * 2);
        ctx.fill();
        // ê·€
        ctx.beginPath();
        ctx.arc(rat.x + 7, rat.y + 5, 5, 0, Math.PI * 2);
        ctx.arc(rat.x + rat.w - 7, rat.y + 5, 5, 0, Math.PI * 2);
        ctx.fillStyle = "#aaa";
        ctx.fill();
        // ëˆˆ
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.arc(rat.x + 8, rat.y + 10, 2, 0, Math.PI * 2);
        ctx.arc(rat.x + rat.w - 8, rat.y + 10, 2, 0, Math.PI * 2);
        ctx.fill();
        // ì²´ë ¥ë°”
        ctx.fillStyle = "#f00";
        ctx.fillRect(rat.x, rat.y - 8, rat.w * (rat.hp / rat.maxHp), 4);
        ctx.strokeStyle = "#222";
        ctx.strokeRect(rat.x, rat.y - 8, rat.w, 4);
        ctx.restore();
      }

      // ë§ˆì„ í…ìŠ¤íŠ¸
      ctx.save();
      ctx.font = "bold 28px sans-serif";
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "#222";
      ctx.lineWidth = 3;
      ctx.strokeText("ë¬´ë„ˆì§„ ë§ˆì„", 220, 80);
      ctx.fillText("ë¬´ë„ˆì§„ ë§ˆì„", 220, 80);
      ctx.restore();
    }

    function drawCaveMap() {
      // ë•…
      ctx.fillStyle = "#5a4d3a";
      ctx.fillRect(0, 350, 600, 50);

      // ë™êµ´ ì…êµ¬
      ctx.save();
      ctx.fillStyle = "#444";
      ctx.beginPath();
      ctx.ellipse(caveEntrance.x + caveEntrance.width/2, caveEntrance.y + caveEntrance.height/2, caveEntrance.width/2, caveEntrance.height/2, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      // ëŒë§¹ì´ ê·¸ë¦¬ê¸°
      for (const stone of stones) {
        if (stone.r === 0) continue;
        ctx.save();
        ctx.beginPath();
        ctx.arc(stone.x, stone.y, stone.r, 0, Math.PI * 2);
        ctx.fillStyle = "#bbb";
        ctx.fill();
        ctx.restore();
      }

      // ë™êµ´ ì…êµ¬ í…ìŠ¤íŠ¸
      ctx.save();
      ctx.font = "bold 28px sans-serif";
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "#222";
      ctx.lineWidth = 3;
      ctx.strokeText("ë™êµ´ ì…êµ¬", caveEntrance.x + 10, caveEntrance.y - 20);
      ctx.fillText("ë™êµ´ ì…êµ¬", caveEntrance.x + 10, caveEntrance.y - 20);
      ctx.restore();
    }

    function drawCaveInside() {
      // ë™êµ´ ë‚´ë¶€ ë°°ê²½
      ctx.fillStyle = "#222";
      ctx.fillRect(0, 0, 600, 400);
      // ë°”ë‹¥
      ctx.fillStyle = "#444";
      ctx.fillRect(0, 350, 600, 50);

      // ë™êµ´ ë‚´ë¶€ ëŒë§¹ì´ ê·¸ë¦¬ê¸°
      for (const stone of caveStones) {
        if (stone.r === 0) continue;
        ctx.save();
        ctx.beginPath();
        ctx.arc(stone.x, stone.y, stone.r, 0, Math.PI * 2);
        ctx.fillStyle = "#bbb";
        ctx.fill();
        ctx.restore();
      }

      // ì² ê´‘ì„ ê·¸ë¦¬ê¸°
      for (const iron of irons) {
        if (iron.mined) continue;
        ctx.save();
        ctx.beginPath();
        ctx.arc(iron.x, iron.y, iron.r, 0, Math.PI * 2);
        ctx.fillStyle = "#b0b8c9";
        ctx.fill();
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
      }

      // ë™êµ´ ë‚´ë¶€ í…ìŠ¤íŠ¸
      ctx.save();
      ctx.font = "bold 28px sans-serif";
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "#111";
      ctx.lineWidth = 3;
      ctx.strokeText("ë™êµ´", 260, 60);
      ctx.fillText("ë™êµ´", 260, 60);
      ctx.restore();
    }

    function drawPlayer() {
      ctx.fillStyle = player.color;
      ctx.fillRect(player.x, player.y, player.width, player.height);
    }

    function drawGameOver() {
      ctx.save();
      ctx.globalAlpha = 0.85;
      ctx.fillStyle = "#222";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.globalAlpha = 1;
      ctx.font = "bold 40px sans-serif";
      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.fillText("ê²Œì„ ì˜¤ë²„", canvas.width/2, canvas.height/2 - 20);
      ctx.font = "24px sans-serif";
      ctx.fillText("R í‚¤ë¥¼ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œì‘", canvas.width/2, canvas.height/2 + 30);
      ctx.textAlign = "left";
      ctx.restore();
    }

    const keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function updatePlayer() {
      if (gameOver) return; // ê²Œì„ì˜¤ë²„ ì‹œ í”Œë ˆì´ì–´ ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
      player.vy += player.gravity;
      player.y += player.vy;

      // ë°”ë‹¥ ì¶©ëŒ
      if (player.y + player.height >= 350) {
        player.y = 350 - player.height;
        player.vy = 0;
        player.onGround = true;
      } else {
        player.onGround = false;
      }

      // ë§µë³„ ì´ë™ ì œí•œ ë° ë§µ ì „í™˜
      if (currentMap === 'forest') {
        if (keys['ArrowLeft']) {
          if (player.x > 0) {
            player.x -= player.speed;
          } else {
            // ì™¼ìª½ ëì—ì„œ ë‘ë²ˆì§¸ ìˆ²ìœ¼ë¡œ
            currentMap = 'forest2';
            player.x = canvas.width - player.width;
            player.y = 300;
          }
        }
        if (keys['ArrowRight']) {
          if (player.x + player.width < canvas.width) {
            player.x += player.speed;
          } else {
            // ì˜¤ë¥¸ìª½ ëì—ì„œ ë™êµ´ ì…êµ¬ë¡œ
            currentMap = 'caveEntrance';
            player.x = 0;
            player.y = 300;
          }
        }
      } else if (currentMap === 'forest2') {
        if (keys['ArrowLeft']) {
          if (player.x > 0) {
            player.x -= player.speed;
          } else {
            // ì™¼ìª½ ëì—ì„œ ì„¸ë²ˆì§¸ ìˆ²ìœ¼ë¡œ
            currentMap = 'forest3';
            player.x = canvas.width - player.width;
            player.y = 300;
          }
        }
        if (keys['ArrowRight']) {
          if (player.x + player.width < canvas.width) {
            player.x += player.speed;
          } else {
            // ì˜¤ë¥¸ìª½ ëì—ì„œ ì²«ë²ˆì§¸ ìˆ²ìœ¼ë¡œ
            currentMap = 'forest';
            player.x = 0;
            player.y = 300;
          }
        }
      } else if (currentMap === 'forest3') {
        if (keys['ArrowLeft']) {
          if (player.x > 0) {
            player.x -= player.speed;
          } else {
            // ì™¼ìª½ ëì—ì„œ ë¬´ë„ˆì§„ ë§ˆì„ë¡œ
            currentMap = 'village';
            player.x = canvas.width - player.width;
            player.y = 300;
          }
        }
        if (keys['ArrowRight']) {
          if (player.x + player.width < canvas.width) {
            player.x += player.speed;
          } else {
            // ì˜¤ë¥¸ìª½ ëì—ì„œ ë‘ë²ˆì§¸ ìˆ²ìœ¼ë¡œ
            currentMap = 'forest2';
            player.x = 0;
            player.y = 300;
          }
        }
      } else if (currentMap === 'village') {
        if (keys['ArrowRight']) {
          if (player.x + player.width < canvas.width) {
            player.x += player.speed;
          } else {
            // ì˜¤ë¥¸ìª½ ëì—ì„œ ì„¸ë²ˆì§¸ ìˆ²ìœ¼ë¡œ
            currentMap = 'forest3';
            player.x = 0;
            player.y = 300;
          }
        }
        if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
      } else if (currentMap === 'caveEntrance') {
        // ë™êµ´ ì…êµ¬ì—ì„œ ë™êµ´ ë‚´ë¶€ë¡œ ì§„ì…
        // ë™êµ´ ì…êµ¬ íƒ€ì›ê³¼ í”Œë ˆì´ì–´ ì¶©ëŒ ì²´í¬
        const px = player.x + player.width / 2;
        const py = player.y + player.height / 2;
        const cx = caveEntrance.x + caveEntrance.width / 2;
        const cy = caveEntrance.y + caveEntrance.height / 2;
        const rx = caveEntrance.width / 2;
        const ry = caveEntrance.height / 2;
        // íƒ€ì› ë‚´ë¶€ íŒì •
        const inCave = ((px - cx) ** 2) / (rx ** 2) + ((py - cy) ** 2) / (ry ** 2) < 1;
        if (inCave) {
          currentMap = 'cave';
          player.x = 40;
          player.y = 300;
          return;
        }
        if (keys['ArrowLeft']) {
          if (player.x > 0) {
            player.x -= player.speed;
          } else {
            // ì™¼ìª½ ëì—ì„œ ë‹¤ì‹œ ìˆ²ìœ¼ë¡œ
            currentMap = 'forest';
            player.x = canvas.width - player.width;
            player.y = 300;
          }
        }
        if (keys['ArrowRight'] && player.x + player.width < canvas.width) player.x += player.speed;
      } else if (currentMap === 'cave') {
        if (keys['ArrowLeft']) {
          if (player.x > 0) {
            player.x -= player.speed;
          } else {
            // ë™êµ´ì—ì„œ ì™¼ìª½ ëìœ¼ë¡œ ë‚˜ê°€ë©´ ë™êµ´ ì…êµ¬ë¡œ (ì™¼ìª½ì—ì„œ ë“±ì¥)
            currentMap = 'caveEntrance';
            player.x = 0;
            player.y = 300;
          }
        }
        if (keys['ArrowRight'] && player.x + player.width < canvas.width) player.x += player.speed;
      }
      if (keys['ArrowUp'] && player.y > 0) player.y -= player.speed;
      if (keys['ArrowDown'] && player.y + player.height < 350) player.y += player.speed;

      if (player.hp <= 0) {
        player.hp = 0;
        gameOver = true;
        showInventory(true);
        document.getElementById('craft-msg').textContent = "ğŸ’€ ê²Œì„ ì˜¤ë²„! R í‚¤ë¡œ ì¬ì‹œì‘";
        return;
      }
    }

    // ë§ˆì„ ì¥ AI ë° ì¶©ëŒ ì²˜ë¦¬ (í”Œë ˆì´ì–´ë¥¼ ê³µê²©í•¨)
    function updateVillageRats() {
      if (gameOver) return; // ê²Œì„ì˜¤ë²„ ì‹œ ì¥ ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
      let damaged = false;
      let damageAmount = 0;
      for (const rat of rats) {
        if (!rat.alive) continue;
        // ê°„ë‹¨í•œ ì¢Œìš° ì´ë™
        rat.x += rat.dir * 1.2;
        if (rat.x < 40) { rat.x = 40; rat.dir = 1; }
        if (rat.x > 530) { rat.x = 530; rat.dir = -1; }
        // í”Œë ˆì´ì–´ì™€ ì¶©ëŒ ì‹œ ê³µê²©
        if (
          player.x + player.width > rat.x &&
          player.x < rat.x + rat.w &&
          player.y + player.height > rat.y &&
          player.y < rat.y + rat.h
        ) {
          if (rat.hitTimer <= 0) {
            player.hp -= rat.attack;
            damageAmount += rat.attack;
            damaged = true;
            rat.hitTimer = 60; // 1ì´ˆ ì¿¨íƒ€ì„ (60í”„ë ˆì„)
            if (player.hp < 0) player.hp = 0;
          }
        }
        if (rat.hitTimer > 0) rat.hitTimer--;
      }
      // ì¸ë²¤í† ë¦¬ ê°±ì‹ (ì±„ë ¥ ë°˜ì˜)
      if (damaged) updateInventory();
    }

    // ì í”„ ì´ë²¤íŠ¸
    window.addEventListener('keydown', function(e) {
      if ((e.code === 'Space' || e.code === 'ArrowUp') && player.onGround) {
        player.vy = player.jumpPower;
      }
    });

    // í”Œë ˆì´ì–´ ê³µê²©(ìŠ¤í˜ì´ìŠ¤ë°”) ì²˜ë¦¬
    window.addEventListener('keydown', function(e) {
      if (e.code === 'Space') {
        if (currentMap === 'village') {
          for (const rat of rats) {
            if (!rat.alive) continue;
            // ê³µê²© ë²”ìœ„: í”Œë ˆì´ì–´ ì• 40í”½ì…€
            let attackRange = player.x + player.width + 40;
            if (
              rat.x < attackRange &&
              rat.x + rat.w > player.x &&
              Math.abs(player.y - rat.y) < 40
            ) {
              let dmg = hasSword ? 3.5 : 0;
              if (dmg > 0) {
                rat.hp -= dmg;
                if (rat.hp <= 0) {
                  rat.alive = false;
                }
              }
            }
          }
        }
      }
    });

    // í”Œë ˆì´ì–´ ê³µê²©(í‚¤: E) ì²˜ë¦¬
    window.addEventListener('keydown', function(e) {
      if (e.code === 'KeyE') {
        if (currentMap === 'village') {
          for (const rat of rats) {
            if (!rat.alive) continue;
            // ê³µê²© ë²”ìœ„: í”Œë ˆì´ì–´ ì• 40í”½ì…€
            let attackRange = player.x + player.width + 40;
            if (
              rat.x < attackRange &&
              rat.x + rat.w > player.x &&
              Math.abs(player.y - rat.y) < 40
            ) {
              let dmg = hasSword ? 3.5 : 0;
              if (dmg > 0) {
                rat.hp -= dmg;
                if (rat.hp <= 0) {
                  rat.alive = false;
                }
              }
            }
          }
        }
      }
    });

    // R í‚¤ë¡œ ê²Œì„ ì¬ì‹œì‘
    window.addEventListener('keydown', function(e) {
      if (gameOver && (e.code === 'KeyR' || e.code === 'Keyr')) {
        // ìƒíƒœ ì´ˆê¸°í™”
        currentMap = 'forest';
        player.x = 100;
        player.y = 300;
        player.hp = player.maxHp;
        player.vy = 0;
        woodCount = 0;
        stoneCount = 0;
        ironCount = 0;
        hasAxe = false;
        hasPickaxe = false;
        hasSword = false;
        player.attack = 0;
        // ë‚˜ë¬´, ëŒ, ì² ê´‘ì„, ì¥, ê¸°íƒ€ ë¦¬ì…‹
        for (const tree of trees) {
          tree.chopped = false;
          tree.chopCount = 0;
        }
        for (const stone of stones) {
          stone.r = Math.max(stone.r, 7); // ì›ë˜ ë°˜ì§€ë¦„ ë³µêµ¬
        }
        for (const stone of caveStones) {
          stone.r = Math.max(stone.r, 7);
        }
        for (const iron of irons) {
          iron.mined = false;
        }
        rats.length = 0;
        villageEntered = false;
        gameOver = false;
        showInventory(false);
        updateInventory();
      }
    });

    // ì¸ë²¤í† ë¦¬
    let woodCount = 0;
    let stoneCount = 0;
    let ironCount = 0;
    let inventoryVisible = false;
    let hasAxe = false;
    let hasPickaxe = false;

    function updateInventory() {
      inventoryDiv.innerHTML = `
        <div style="margin-bottom:8px;">
          <b>ì¸ë²¤í† ë¦¬</b>
        </div>
        <div>ğŸŒ² ë‚˜ë¬´: ${woodCount}</div>
        <div>ğŸª¨ ëŒ: ${stoneCount}</div>
        <div>â›ï¸ ì² ê´‘ì„: ${ironCount}</div>
        <div>ğŸª“ ë„ë¼: ${hasAxe ? "ë³´ìœ " : "ì—†ìŒ"}</div>
        <div>â›ï¸ ê³¡ê´­ì´: ${hasPickaxe ? "ë³´ìœ " : "ì—†ìŒ"}</div>
        <div>ğŸ—¡ï¸ ê²€: ${hasSword ? "ë³´ìœ (ê³µê²©ë ¥ 3.5)" : "ì—†ìŒ"}</div>
        <div>â¤ï¸ ì²´ë ¥: ${player.hp} / ${player.maxHp}</div>
        <hr>
        <div><b>ì œì‘</b></div>
        <div>
          <button id="craft-axe" style="margin-top:4px;" ${hasAxe ? "disabled" : ""}>ë„ë¼ ì œì‘ (ë‚˜ë¬´ 3, ëŒ 2)</button>
        </div>
        <div>
          <button id="craft-pickaxe" style="margin-top:4px;" ${hasPickaxe ? "disabled" : ""}>ê³¡ê´­ì´ ì œì‘ (ë‚˜ë¬´ 10, ëŒ 3)</button>
        </div>
        <div>
          <button id="craft-sword" style="margin-top:4px;" ${hasSword ? "disabled" : ""}>ê²€ ì œì‘ (ë‚˜ë¬´ 4, ëŒ 8)</button>
        </div>
        <div id="craft-msg" style="color:#b00; min-height:20px; font-size:15px;"></div>
      `;
      // ë„ë¼ ì œì‘ ë²„íŠ¼
      const axeBtn = document.getElementById('craft-axe');
      if (axeBtn) {
        axeBtn.onclick = function() {
          if (hasAxe) return;
          if (woodCount >= 3 && stoneCount >= 2) {
            woodCount -= 3;
            stoneCount -= 2;
            hasAxe = true;
            document.getElementById('craft-msg').textContent = "ë„ë¼ë¥¼ ì œì‘í–ˆìŠµë‹ˆë‹¤!";
            updateInventory();
          } else {
            document.getElementById('craft-msg').textContent = "ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.";
          }
        };
      }
      // ê³¡ê´­ì´ ì œì‘ ë²„íŠ¼
      const pickaxeBtn = document.getElementById('craft-pickaxe');
      if (pickaxeBtn) {
        pickaxeBtn.onclick = function() {
          if (hasPickaxe) return;
          if (woodCount >= 10 && stoneCount >= 3) {
            woodCount -= 10;
            stoneCount -= 3;
            hasPickaxe = true;
            document.getElementById('craft-msg').textContent = "ê³¡ê´­ì´ë¥¼ ì œì‘í–ˆìŠµë‹ˆë‹¤!";
            updateInventory();
          } else {
            document.getElementById('craft-msg').textContent = "ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.";
          }
        };
      }
      // ê²€ ì œì‘ ë²„íŠ¼
      const swordBtn = document.getElementById('craft-sword');
      if (swordBtn) {
        swordBtn.onclick = function() {
          if (hasSword) return;
          if (woodCount >= 4 && stoneCount >= 8) {
            woodCount -= 4;
            stoneCount -= 8;
            hasSword = true;
            player.attack = 3.5;
            document.getElementById('craft-msg').textContent = "ê²€ì„ ì œì‘í–ˆìŠµë‹ˆë‹¤!";
            updateInventory();
          } else {
            document.getElementById('craft-msg').textContent = "ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.";
          }
        };
      }
    }

    function showInventory(show) {
      inventoryVisible = show;
      if (show) {
        inventoryDiv.classList.add('show');
        updateInventory();
      } else {
        inventoryDiv.classList.remove('show');
      }
    }

    // ë‚˜ë¬´/ëŒ/ì² ê´‘ì„ í´ë¦­ ì²˜ë¦¬
    canvas.addEventListener('mousedown', function(e) {
      if (e.button !== 0) return; // ì¢Œí´ë¦­ë§Œ
      if (currentMap === 'forest') {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        for (const tree of trees) {
          if (tree.chopped) continue;
          // ë‚˜ë¬´ ì¤„ê¸°ì™€ ì ì˜ì—­ ì²´í¬
          const inTrunk = mx >= tree.x && mx <= tree.x + tree.width && my >= tree.y && my <= tree.y + tree.height;
          const dx = mx - (tree.x + tree.width/2);
          const dy = my - tree.y;
          const inLeaf = dy <= 0 && dx*dx + dy*dy <= tree.radius*tree.radius;
          if (inTrunk || inLeaf) {
            // ë„ë¼ê°€ ìˆìœ¼ë©´ 3ë²ˆ, ì—†ìœ¼ë©´ 10ë²ˆ
            tree.chopCount += hasAxe ? 3 : 1;
            // ê°„ë‹¨í•œ íš¨ê³¼: ë‚˜ë¬´ í”ë“¤ë¦¼(ìƒ‰ìƒ ë³€ê²½)
            ctx.save();
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = "#fff";
            ctx.fillRect(tree.x, tree.y, tree.width, tree.height);
            ctx.restore();
            if ((hasAxe && tree.chopCount >= 3) || (!hasAxe && tree.chopCount >= 10)) {
              tree.chopped = true;
              woodCount += 5;
              updateInventory();
            }
            break;
          }
        }
      } else if (currentMap === 'caveEntrance') {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        for (const stone of stones) {
          if (stone.r === 0) continue; // ì´ë¯¸ ì‚¬ë¼ì§„ ëŒì€ ë¬´ì‹œ
          const dx = mx - stone.x;
          const dy = my - stone.y;
          if (dx*dx + dy*dy <= stone.r*stone.r) {
            stoneCount += 1;
            stone.r = 0; // ëŒë§¹ì´ ì‚¬ë¼ì§€ê²Œ ë°˜ì§€ë¦„ 0ìœ¼ë¡œ
            updateInventory();
            break;
          }
        }
      } else if (currentMap === 'cave') {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        // ë™êµ´ ë‚´ë¶€ ëŒë§¹ì´ í´ë¦­ ì²˜ë¦¬
        for (const stone of caveStones) {
          if (stone.r === 0) continue;
          const dx = mx - stone.x;
          const dy = my - stone.y;
          if (dx*dx + dy*dy <= stone.r*stone.r) {
            stoneCount += 1;
            stone.r = 0;
            updateInventory();
            return;
          }
        }
        // ì² ê´‘ì„ í´ë¦­ ì²˜ë¦¬ (ê³¡ê´­ì´ í•„ìš”)
        for (const iron of irons) {
          if (iron.mined) continue;
          const dx = mx - iron.x;
          const dy = my - iron.y;
          if (dx*dx + dy*dy <= iron.r*iron.r) {
            if (!hasPickaxe) {
              showInventory(true);
              document.getElementById('craft-msg').textContent = "â›ï¸ ê³¡ê´­ì´ê°€ í•„ìš”í•©ë‹ˆë‹¤!";
              return;
            }
            iron.mined = true;
            ironCount += 1;
            updateInventory();
            break;
          }
        }
      }
    });

    // Tab í‚¤ë¡œ ì¸ë²¤í† ë¦¬ í† ê¸€
    window.addEventListener('keydown', function(e) {
      if (e.code === 'Tab') {
        e.preventDefault();
        showInventory(!inventoryVisible);
      }
    });

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (gameOver) {
        drawGameOver();
        requestAnimationFrame(gameLoop);
        return;
      }
      if (currentMap === 'forest') {
        drawForest();
      } else if (currentMap === 'forest2') {
        drawForest2();
      } else if (currentMap === 'forest3') {
        drawForest3();
      } else if (currentMap === 'village') {
        // ì¥ ìŠ¤í° ê´€ë¦¬
        if (!villageEntered) {
          rats.length = 0;
          spawnRat();
          villageEntered = true;
          ratSpawnTimer = Date.now();
        }
        // 4ì´ˆë§ˆë‹¤ 3ë§ˆë¦¬ ìŠ¤í°
        if (Date.now() - ratSpawnTimer > 4000) {
          for (let i = 0; i < 3; i++) spawnRat();
          ratSpawnTimer = Date.now();
        }
        updateVillageRats();
        drawVillage();
      } else if (currentMap === 'caveEntrance') {
        drawCaveMap();
      } else if (currentMap === 'cave') {
        drawCaveInside();
      }
      updatePlayer();
      drawPlayer();
      requestAnimationFrame(gameLoop);
    }

    // ìµœì´ˆ ì¸ë²¤í† ë¦¬ ìˆ¨ê¹€
    showInventory(false);
    gameLoop();
  </script>
</body>
</html>
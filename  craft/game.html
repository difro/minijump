<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini Jump King</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; background: #87ceeb; float: left; }
    #info {
      position: absolute;
      left: 520px;
      top: 70px;
      width: 320px;
      font-family: Arial, sans-serif;
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      padding: 18px 20px 18px 20px;
      box-shadow: 2px 2px 8px #aaa;
      font-size: 16px;
      color: #222;
      z-index: 10;
    }
    .color-box {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 6px;
      vertical-align: middle;
      border: 1px solid #888;
    }
    .desc-row { margin-bottom: 8px; }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<div id="info">
  <!-- ì„¤ëª… ë‚´ìš©ì€ drawInfo()ì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›€ -->
</div>
<button id="skipStageBtn" style="position:absolute; left:840px; top:30px; width:260px; height:40px; font-size:18px; border-radius:8px; border:1px solid #888; background:#f5f5f5; cursor:pointer; z-index:20;">
  ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ìŠ¤í‚µ
</button>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = 500;
canvas.height = 800;

const player = {
  x: 180,
  y: 680,
  width: 20,
  height: 20,
  color: 'red',
  vx: 0,
  vy: 0,
  jumpPower: -10,
  grounded: false,
  canDoubleJump: false,
  hasJumped: false
};

let keys = {};
const gravity = 0.6;
let gameOver = false;
let gameClear = false;
let currentStage = 0;

// ì£½ì€ íšŸìˆ˜ ë³€ìˆ˜
let deathCount = 0;

// ë ˆì´ì € í•¨ì • ì •ì˜
function createLaser(x, y, direction, interval, duration, length) {
  return { x, y, direction, interval, duration, length, timer: 0, active: false };
}

function createStageEasy(startY) {
  // 1ìŠ¤í…Œì´ì§€: ì‹œì‘ ë°œíŒ í¬í•¨, ì—¬ëŸ¬ ë°œíŒ...
  return [
    { x: 180, y: startY, width: 100, height: 12 }, // ì‹œì‘ ë°œíŒ
    { x: 220, y: startY - 60, width: 90, height: 12 },
    { x: 160, y: startY - 120, width: 80, height: 12 },
    { x: 200, y: startY - 180, width: 80, height: 12 },
    { x: 240, y: startY - 240, width: 80, height: 12 },
    { x: 180, y: startY - 300, width: 80, height: 12 },
    { x: 220, y: startY - 360, width: 80, height: 12 },
    { x: 160, y: startY - 420, width: 80, height: 12 },
    { x: 200, y: startY - 480, width: 100, height: 12, isDoor: true }
  ];
}

function createStageNormal(startY, offsetX = 0) {
  // 2~3ìŠ¤í…Œì´ì§€: ì‹œì‘ ë°œíŒ ì¶”ê°€
  return [
    { x: 200 + offsetX, y: startY, width: 80, height: 10 }, // ì‹œì‘ ë°œíŒ
    { x: 150 + offsetX, y: startY - 50, width: 70, height: 10 },
    { x: 250 + offsetX, y: startY - 110, width: 70, height: 10 },
    { x: 180 + offsetX, y: startY - 170, width: 60, height: 10 },
    { x: 100 + offsetX, y: startY - 230, width: 60, height: 10 },
    { x: 300 + offsetX, y: startY - 290, width: 60, height: 10 },
    { x: 200 + offsetX, y: startY - 350, width: 80, height: 10, isDoor: true }
  ];
}

function createStageHard(startY, offsetX = 0) {
  // 4~5ìŠ¤í…Œì´ì§€: ì‹œì‘ ë°œíŒ ì¶”ê°€
  return [
    { x: 200 + offsetX, y: startY, width: 80, height: 10 }, // ì‹œì‘ ë°œíŒ
    { x: 150 + offsetX, y: startY - 40, width: 60, height: 10 },
    { x: 250 + offsetX, y: startY - 80, width: 60, height: 10 },
    { x: 180 + offsetX, y: startY - 120, width: 60, height: 10 },
    { x: 100 + offsetX, y: startY - 160, width: 60, height: 10 },
    { x: 300 + offsetX, y: startY - 200, width: 60, height: 10 },
    { x: 220 + offsetX, y: startY - 240, width: 60, height: 10 },
    { x: 160 + offsetX, y: startY - 280, width: 60, height: 10 },
    { x: 250 + offsetX, y: startY - 320, width: 60, height: 10 },
    { x: 180 + offsetX, y: startY - 360, width: 60, height: 10 },
    { x: 100 + offsetX, y: startY - 400, width: 60, height: 10 },
    { x: 300 + offsetX, y: startY - 440, width: 60, height: 10 },
    { x: 200 + offsetX, y: startY - 480, width: 60, height: 10 },
    { x: 120 + offsetX, y: startY - 520, width: 60, height: 10 },
    { x: 280 + offsetX, y: startY - 560, width: 60, height: 10 },
    { x: 180 + offsetX, y: startY - 600, width: 60, height: 10 },
    { x: 100 + offsetX, y: startY - 640, width: 60, height: 10 },
    { x: 300 + offsetX, y: startY - 680, width: 60, height: 10 },
    { x: 200 + offsetX, y: startY - 720, width: 60, height: 10, isDoor: true }
  ];
}

function createStageExtraHard(startY, offsetX = 0) {
  // 7ìŠ¤í…Œì´ì§€: ë‚œì´ë„ ì™„í™”, ë°œíŒ ê°„ê²©ì„ ì¤„ì´ê³  ê°œìˆ˜ ì¦ê°€
  return [
    { x: 200 + offsetX, y: startY, width: 80, height: 12 },
    { x: 140 + offsetX, y: startY - 50, width: 70, height: 12 },
    { x: 260 + offsetX, y: startY - 100, width: 70, height: 12 },
    { x: 180 + offsetX, y: startY - 150, width: 60, height: 12 },
    { x: 100 + offsetX, y: startY - 200, width: 60, height: 12 },
    { x: 300 + offsetX, y: startY - 250, width: 60, height: 12 },
    { x: 220 + offsetX, y: startY - 300, width: 60, height: 12 },
    { x: 160 + offsetX, y: startY - 350, width: 60, height: 12 },
    { x: 250 + offsetX, y: startY - 400, width: 60, height: 12 },
    { x: 180 + offsetX, y: startY - 450, width: 60, height: 12 },
    { x: 100 + offsetX, y: startY - 500, width: 60, height: 12 },
    { x: 300 + offsetX, y: startY - 550, width: 60, height: 12 },
    { x: 200 + offsetX, y: startY - 600, width: 80, height: 12 },
    { x: 140 + offsetX, y: startY - 650, width: 70, height: 12 },
    { x: 260 + offsetX, y: startY - 700, width: 70, height: 12 },
    { x: 200 + offsetX, y: startY - 750, width: 80, height: 12, isDoor: true }
  ];
}

function createStageLaser(startY, offsetX = 0) {
  // 8, 9ìŠ¤í…Œì´ì§€: ë ˆì´ì €ë§Œ ë“±ì¥, ë°œíŒì€ ì ë‹¹íˆ ë°°ì¹˜
  return [
    { x: 200 + offsetX, y: startY, width: 80, height: 12 },
    { x: 140 + offsetX, y: startY - 60, width: 70, height: 12 },
    { x: 260 + offsetX, y: startY - 120, width: 70, height: 12 },
    { x: 180 + offsetX, y: startY - 180, width: 60, height: 12 },
    { x: 100 + offsetX, y: startY - 240, width: 60, height: 12 },
    { x: 300 + offsetX, y: startY - 300, width: 60, height: 12 },
    { x: 220 + offsetX, y: startY - 360, width: 60, height: 12 },
    { x: 160 + offsetX, y: startY - 420, width: 60, height: 12 },
    { x: 250 + offsetX, y: startY - 480, width: 60, height: 12 },
    { x: 180 + offsetX, y: startY - 540, width: 60, height: 12 },
    { x: 200 + offsetX, y: startY - 600, width: 80, height: 12, isDoor: true }
  ];
}

function createStageBallTrap(startY, offsetX = 0) {
  // 10ìŠ¤í…Œì´ì§€: ë°œíŒ + ë ˆì´ì € + êµ¬ë¥´ëŠ” ê³µ í•¨ì •
  return [
    { x: 200 + offsetX, y: startY, width: 80, height: 12 },
    { x: 140 + offsetX, y: startY - 60, width: 70, height: 12 },
    { x: 260 + offsetX, y: startY - 120, width: 70, height: 12 },
    { x: 180 + offsetX, y: startY - 180, width: 60, height: 12 },
    { x: 100 + offsetX, y: startY - 240, width: 60, height: 12 },
    { x: 300 + offsetX, y: startY - 300, width: 60, height: 12 },
    { x: 220 + offsetX, y: startY - 360, width: 60, height: 12 },
    { x: 160 + offsetX, y: startY - 420, width: 60, height: 12 },
    { x: 250 + offsetX, y: startY - 480, width: 60, height: 12 },
    { x: 180 + offsetX, y: startY - 540, width: 60, height: 12 },
    { x: 200 + offsetX, y: startY - 600, width: 80, height: 12, isDoor: true }
  ];
}

function createStageVanish(startY, offsetX = 0) {
  // 11ìŠ¤í…Œì´ì§€: ì‹œì‘ ë°œíŒ 1ê°œ + ì‚¬ë¼ì§€ëŠ” ë°œíŒ + ë ˆì´ì € + ê³µ
  const plats = [
    { x: 200 + offsetX, y: startY, width: 80, height: 12, isStart: true }, // ì‹œì‘ ë°œíŒ(ì•ˆ ì‚¬ë¼ì§)
    // ì‚¬ë¼ì§€ëŠ” ë°œíŒë“¤
    { x: 140 + offsetX, y: startY - 60, width: 70, height: 12, vanish: true },
    { x: 260 + offsetX, y: startY - 120, width: 70, height: 12, vanish: true },
    { x: 180 + offsetX, y: startY - 180, width: 60, height: 12, vanish: true },
    { x: 100 + offsetX, y: startY - 240, width: 60, height: 12, vanish: true },
    { x: 300 + offsetX, y: startY - 300, width: 60, height: 12, vanish: true },
    { x: 220 + offsetX, y: startY - 360, width: 60, height: 12, vanish: true },
    { x: 160 + offsetX, y: startY - 420, width: 60, height: 12, vanish: true },
    { x: 250 + offsetX, y: startY - 480, width: 60, height: 12, vanish: true },
    { x: 180 + offsetX, y: startY - 540, width: 60, height: 12, vanish: true },
    { x: 200 + offsetX, y: startY - 600, width: 80, height: 12, isDoor: true }
  ];
  return plats;
}

function createStageMissile(startY, offsetX = 0) {
  // 12ìŠ¤í…Œì´ì§€: ì¼ë¶€ íšŒìƒ‰(ì‚¬ë¼ì§€ëŠ”) ë°œíŒ í¬í•¨
  return [
    { x: 200 + offsetX, y: startY, width: 80, height: 12, isStart: true }, // ì‹œì‘ ë°œíŒ
    { x: 140 + offsetX, y: startY - 60, width: 70, height: 12, vanish: true }, // íšŒìƒ‰
    { x: 260 + offsetX, y: startY - 120, width: 70, height: 12 },
    { x: 180 + offsetX, y: startY - 180, width: 60, height: 12, vanish: true }, // íšŒìƒ‰
    { x: 100 + offsetX, y: startY - 240, width: 60, height: 12 },
    { x: 300 + offsetX, y: startY - 300, width: 60, height: 12, vanish: true }, // íšŒìƒ‰
    { x: 220 + offsetX, y: startY - 360, width: 60, height: 12 },
    { x: 160 + offsetX, y: startY - 420, width: 60, height: 12 },
    { x: 250 + offsetX, y: startY - 480, width: 60, height: 12, vanish: true }, // íšŒìƒ‰
    { x: 180 + offsetX, y: startY - 540, width: 60, height: 12 },
    { x: 200 + offsetX, y: startY - 600, width: 80, height: 12, isDoor: true }
  ];
}

function createStageKeyDoor(startY, offsetX = 0) {
  // 13ìŠ¤í…Œì´ì§€: ì˜¤ë¥¸ìª½ ì•„ë˜ì— ë¬¸, ì£¼ë³€ ë²½, ìœ„ì— ì—´ì‡ ë¬¸, ë§¨ ìœ„ ì–´ë”˜ê°€ì— ì—´ì‡ , íšŒìƒ‰ ë°œíŒ, ë ˆì´ì €, í•‘í¬ìƒ‰ íŠ€ëŠ” ê³µ
  const plats = [
    // ê¸°ë³¸ ë°œíŒ
    { x: 40, y: startY, width: 80, height: 12 }, // ì‹œì‘ ë°œíŒ
    { x: 120, y: startY - 60, width: 60, height: 12, vanish: true }, // íšŒìƒ‰
    { x: 200, y: startY - 120, width: 60, height: 12 },
    { x: 300, y: startY - 180, width: 60, height: 12, vanish: true }, // íšŒìƒ‰
    { x: 400, y: startY - 240, width: 60, height: 12 },
    { x: 250, y: startY - 320, width: 60, height: 12 },
    { x: 100, y: startY - 400, width: 60, height: 12, vanish: true }, // íšŒìƒ‰
    { x: 350, y: startY - 480, width: 60, height: 12 },
    { x: 200, y: 60, width: 60, height: 12 }, // ë§¨ ìœ„ ì—´ì‡  ë°œíŒ
    // ì˜¤ë¥¸ìª½ ì•„ë˜ ë¬¸(ì—´ì‡ ë¬¸)
    { x: 420, y: 780, width: 60, height: 20, isDoor: true, isKeyDoor: true },
    // ë¬¸ ìœ„ìª½ì— ë²½(ì¢Œ/ìš°/ìœ„)
    { x: 420, y: 760, width: 60, height: 20, isWall: true },
    { x: 480, y: 700, width: 20, height: 80, isWall: true },
    { x: 400, y: 700, width: 20, height: 80, isWall: true }
  ];
  // ì—´ì‡  ìœ„ì¹˜ ì •ë³´(í”Œë«í¼ì´ ì•„ë‹˜)
  plats.key = { x: 230, y: 40, width: 24, height: 24 };
  return plats;
}

// ìŠ¤í…Œì´ì§€ ë‚œì´ë„ë³„ë¡œ êµ¬ì„±
const stages = [
  createStageEasy(750),               // 1ìŠ¤í…Œì´ì§€: ë§¤ìš° ì‰¬ì›€
  createStageNormal(750, 30),         // 2ìŠ¤í…Œì´ì§€: ë³´í†µ
  createStageNormal(750, -40),        // 3ìŠ¤í…Œì´ì§€: ë³´í†µ
  createStageHard(750, 60),           // 4ìŠ¤í…Œì´ì§€: ì–´ë ¤ì›€
  createStageHard(750, -60),          // 5ìŠ¤í…Œì´ì§€: ì–´ë ¤ì›€
  createStageHard(750, 0),            // 6ìŠ¤í…Œì´ì§€: ë§¤ìš° ì–´ë ¤ì›€(ê¸°ì¡´ hard ì¬í™œìš©)
  createStageExtraHard(750, 0),       // 7ìŠ¤í…Œì´ì§€: ê·¹ì•…
  createStageLaser(750, 0),           // 8ìŠ¤í…Œì´ì§€: ë ˆì´ì €
  createStageLaser(750, 60),          // 9ìŠ¤í…Œì´ì§€: ë ˆì´ì €
  createStageBallTrap(750, 0),        // 10ìŠ¤í…Œì´ì§€: ë ˆì´ì €+ê³µ
  createStageVanish(750, 0),          // 11ìŠ¤í…Œì´ì§€: ì‚¬ë¼ì§€ëŠ” ë°œíŒ+ê³µ+ë ˆì´ì €
  createStageMissile(750, 0),         // 12ìŠ¤í…Œì´ì§€: ì‚¬ë¼ì§€ëŠ” ë°œíŒ+ë ˆì´ì €+ê³µ+ìœ ë„íƒ„
  createStageKeyDoor(750, 0),         // 13ìŠ¤í…Œì´ì§€: ì—´ì‡ ë¬¸/ì—´ì‡ /ë²½/íŠ¹ìˆ˜ê³µ
];

// ê° ë‚œì´ë„ì— ë§ëŠ” í•¨ì • ë ˆì´ì•„ì›ƒ
const trapLayouts = [
  // 1ìŠ¤í…Œì´ì§€: ê±°ì˜ í•¨ì • ì—†ìŒ
  [
    // ì¼ë¶€ëŸ¬ ì‰¬ìš´ í•¨ì •ë§Œ 1~2ê°œ
    { x: 220, y: 690, width: 30, height: 10 }
  ],
  // 2ìŠ¤í…Œì´ì§€: ì•½ê°„ì˜ í•¨ì •
  [
    { x: 220, y: 700, width: 30, height: 10 },
    { x: 180, y: 600, width: 30, height: 10, bounce: true }
  ],
  // 3ìŠ¤í…Œì´ì§€: í•¨ì • ì¡°ê¸ˆ ë” ì¶”ê°€
  [
    { x: 230, y: 680, width: 30, height: 10 },
    { x: 170, y: 570, width: 30, height: 10, bounce: true },
    { x: 250, y: 500, width: 30, height: 10, teleport: { x: 210, y: 700 } }
  ],
  // 4ìŠ¤í…Œì´ì§€: ê¸°ì¡´ê³¼ ë¹„ìŠ·í•˜ê²Œ í•¨ì • ë§ìŒ
  [
    { x: 210, y: 710, width: 30, height: 10 },
    { x: 260, y: 670, width: 30, height: 10 },
    { x: 100, y: 630, width: 30, height: 10 },
    { x: 300, y: 590, width: 30, height: 10 },
    { x: 150, y: 550, width: 30, height: 10 },
    { x: 250, y: 510, width: 30, height: 10 },
    { x: 120, y: 470, width: 30, height: 10 },
    { x: 180, y: 430, width: 30, height: 10 },
    { x: 220, y: 390, width: 30, height: 10, bounce: true },
    { x: 300, y: 350, width: 30, height: 10, teleportToStart: true },
    { x: 180, y: 310, width: 30, height: 10, teleport: { x: 100, y: 700 } }
  ],
  // 5ìŠ¤í…Œì´ì§€: ê¸°ì¡´ê³¼ ë¹„ìŠ·í•˜ê²Œ í•¨ì • ë§ìŒ
  [
    { x: 160, y: 690, width: 30, height: 10 },
    { x: 240, y: 650, width: 30, height: 10 },
    { x: 180, y: 610, width: 30, height: 10 },
    { x: 100, y: 570, width: 30, height: 10 },
    { x: 300, y: 530, width: 30, height: 10, bounce: true },
    { x: 200, y: 490, width: 30, height: 10, teleport: { x: 180, y: 300 } },
    { x: 120, y: 450, width: 30, height: 10 },
    { x: 250, y: 410, width: 30, height: 10 },
    { x: 150, y: 370, width: 30, height: 10 },
    { x: 220, y: 330, width: 30, height: 10, teleportToStart: true }
  ],
  // 6ìŠ¤í…Œì´ì§€: í•¨ì • ë§ìŒ, ìˆœê°„ì´ë™/íŠ•ê¹€/ì¦‰ì‚¬ ì„ìŒ
  [
    { x: 210, y: 710, width: 30, height: 10 },
    { x: 260, y: 670, width: 30, height: 10, bounce: true },
    { x: 100, y: 630, width: 30, height: 10, teleport: { x: 300, y: 700 } },
    { x: 300, y: 590, width: 30, height: 10 },
    { x: 150, y: 550, width: 30, height: 10, bounce: true },
    { x: 250, y: 510, width: 30, height: 10, teleportToStart: true },
    { x: 120, y: 470, width: 30, height: 10 },
    { x: 180, y: 430, width: 30, height: 10, bounce: true },
    { x: 220, y: 390, width: 30, height: 10, teleport: { x: 100, y: 700 } },
    { x: 300, y: 350, width: 30, height: 10, teleportToStart: true },
    { x: 180, y: 310, width: 30, height: 10 }
  ],
  // 7ìŠ¤í…Œì´ì§€: ê·¹ì•…, ìˆœê°„ì´ë™/íŠ•ê¹€/ì¦‰ì‚¬/ì²˜ìŒìœ¼ë¡œ ì„ìŒ (ë‚œì´ë„ ì™„í™”)
  [
    { x: 200, y: 740, width: 30, height: 10, bounce: true },
    { x: 120, y: 700, width: 30, height: 10, teleport: { x: 280, y: 700 } },
    { x: 100, y: 580, width: 30, height: 10, bounce: true },
    { x: 300, y: 540, width: 30, height: 10, teleport: { x: 100, y: 700 } },
    { x: 220, y: 500, width: 30, height: 10 },
    { x: 250, y: 420, width: 30, height: 10, bounce: true },
    { x: 180, y: 380, width: 30, height: 10 },
    // ë ˆì´ì € ì¶”ê°€ (ê°€ë¡œ, 2ì´ˆë§ˆë‹¤ 0.7ì´ˆê°„ ë°œì‚¬)
    { laser: true, x: 100, y: 650, direction: 'horizontal', interval: 120, duration: 42, length: 300 },
    // ë ˆì´ì € ì¶”ê°€ (ì„¸ë¡œ, 3ì´ˆë§ˆë‹¤ 1ì´ˆê°„ ë°œì‚¬)
    { laser: true, x: 250, y: 400, direction: 'vertical', interval: 180, duration: 60, length: 200 }
  ],
  // 8ìŠ¤í…Œì´ì§€: ë ˆì´ì €ë§Œ ë“±ì¥
  [
    { laser: true, x: 120, y: 720, direction: 'horizontal', interval: 100, duration: 40, length: 260 },
    { laser: true, x: 250, y: 600, direction: 'vertical', interval: 120, duration: 50, length: 300 },
    { laser: true, x: 180, y: 500, direction: 'horizontal', interval: 80, duration: 30, length: 200 },
    { laser: true, x: 300, y: 400, direction: 'vertical', interval: 90, duration: 30, length: 350 }
  ],
  // 9ìŠ¤í…Œì´ì§€: ë ˆì´ì €ë§Œ ë“±ì¥, ë” ì´˜ì´˜í•˜ê²Œ
  [
    // ì‹œì‘ ìœ„ì¹˜ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ y=750, x=100 ë ˆì´ì €ë¥¼ y=700ìœ¼ë¡œ ë‚´ë¦¼
    { laser: true, x: 100, y: 700, direction: 'horizontal', interval: 80, duration: 32, length: 350 },
    // ë‚˜ë¨¸ì§€ ë ˆì´ì €ëŠ” ì‹œì‘ ìœ„ì¹˜ì™€ ê²¹ì¹˜ì§€ ì•Šìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ë‘ 
    { laser: true, x: 250, y: 650, direction: 'vertical', interval: 100, duration: 40, length: 350 },
    { laser: true, x: 180, y: 550, direction: 'horizontal', interval: 70, duration: 28, length: 250 },
    { laser: true, x: 300, y: 450, direction: 'vertical', interval: 90, duration: 36, length: 350 },
    { laser: true, x: 150, y: 350, direction: 'horizontal', interval: 60, duration: 24, length: 300 }
  ],
  // 10ìŠ¤í…Œì´ì§€: ë ˆì´ì €+ê³µ í•¨ì •
  [
    // ë ˆì´ì € 2ê°œ
    { laser: true, x: 120, y: 720, direction: 'horizontal', interval: 100, duration: 40, length: 260 },
    { laser: true, x: 250, y: 500, direction: 'vertical', interval: 120, duration: 50, length: 300 },
    // ê¸°ì¡´ êµ¬ë¥´ëŠ” ê³µ 3ê°œ
    { ball: true, x: 100, y: 200, vx: 2.5, vy: 0, radius: 18, interval: 180, delay: 0 },
    { ball: true, x: 350, y: 400, vx: -2, vy: 0, radius: 18, interval: 220, delay: 60 },
    { ball: true, x: 250, y: 600, vx: 1.5, vy: 0, radius: 16, interval: 160, delay: 120 },
    // ì¶”ê°€ êµ¬ë¥´ëŠ” ê³µ 3ê°œ
    { ball: true, x: 400, y: 150, vx: -2.2, vy: 0, radius: 15, interval: 200, delay: 30 },
    { ball: true, x: 60, y: 350, vx: 2.8, vy: 0, radius: 14, interval: 170, delay: 90 },
    { ball: true, x: 300, y: 100, vx: 1.7, vy: 0, radius: 13, interval: 210, delay: 150 }
  ],
  // 11ìŠ¤í…Œì´ì§€: ë ˆì´ì €+ê³µ
  [
    // ë ˆì´ì € 2ê°œ
    { laser: true, x: 120, y: 720, direction: 'horizontal', interval: 90, duration: 36, length: 260 },
    { laser: true, x: 250, y: 400, direction: 'vertical', interval: 110, duration: 44, length: 350 },
    // êµ¬ë¥´ëŠ” ê³µ 2ê°œ
    { ball: true, x: 100, y: 200, vx: 2.5, vy: 0, radius: 18, interval: 180, delay: 0 },
    { ball: true, x: 350, y: 400, vx: -2, vy: 0, radius: 18, interval: 220, delay: 60 }
  ],
  // 12ìŠ¤í…Œì´ì§€: ì‚¬ë¼ì§€ëŠ” ë°œíŒ+ë ˆì´ì €+ê³µ+ìœ ë„íƒ„
  [
    // ì¤‘ê°„ ë ˆì´ì €
    { laser: true, x: 120, y: 400, direction: 'horizontal', interval: 90, duration: 36, length: 260 },
    // ìœ„ìª½ êµ¬ë¥´ëŠ” ê³µ
    { ball: true, x: 250, y: 150, vx: 2.5, vy: 0, radius: 18, interval: 180, delay: 0 },
    // ìœ ë„íƒ„(ë¯¸ì‚¬ì¼) - ì•„ë˜ì—ì„œ ìœ„ë¡œ, í”Œë ˆì´ì–´ë¥¼ ë”°ë¼ê°
    { missile: true, x: 60, y: 780, speed: 2.2, cooldown: 120, delay: 0 },
    { missile: true, x: 400, y: 780, speed: 2.2, cooldown: 160, delay: 60 }
  ],
  // 13ìŠ¤í…Œì´ì§€: ë ˆì´ì €, í•‘í¬ìƒ‰ íŠ€ëŠ” ê³µ, íšŒìƒ‰ ë°œíŒ ì•½ê°„
  [
    // ë ˆì´ì €
    { laser: true, x: 100, y: 500, direction: 'horizontal', interval: 90, duration: 36, length: 300 },
    { laser: true, x: 250, y: 300, direction: 'vertical', interval: 120, duration: 50, length: 350 },
    // í•‘í¬ìƒ‰ íŠ€ëŠ” ê³µ (bouncy: true, color: pink)
    { ball: true, x: 120, y: 200, vx: 2.5, vy: -8, radius: 18, interval: 180, delay: 0, bouncy: true, color: "#e06" },
    { ball: true, x: 380, y: 400, vx: -2.2, vy: -7, radius: 18, interval: 220, delay: 60, bouncy: true, color: "#e06" }
    // íšŒìƒ‰ ë°œíŒì€ í”Œë«í¼ì— í¬í•¨
  ]
];

// ë ˆì´ì €ë§Œ ì¶”ì¶œ
function getLasersForStage(stageIdx) {
  return trapLayouts[stageIdx].filter(t => t.laser).map(t => ({
    ...t,
    timer: 0,
    active: false
  }));
}

// ê¸°ì¡´ í•¨ì •ë§Œ ì¶”ì¶œ
function getTrapsForStage(stageIdx) {
  // ì‰¬ìš´ ìŠ¤í…Œì´ì§€ëŠ” ì¶”ê°€ í•¨ì • ê±°ì˜ ì—†ìŒ, ë’¤ë¡œ ê°ˆìˆ˜ë¡ ê¸°ì¡´ ë°©ì‹
  if (stageIdx === 0) {
    return trapLayouts[stageIdx];
  }
  if (stageIdx === 1 || stageIdx === 2) {
    return trapLayouts[stageIdx].concat(
      stages[stageIdx]
        .filter(p => !p.isDoor)
        .map((p, i) => {
          if (i % 5 === 0) return { x: p.x + 10, y: p.y - 10, width: 30, height: 10 };
          return null;
        })
        .filter(t => t !== null)
    );
  }
  // 4,5ìŠ¤í…Œì´ì§€ëŠ” ê¸°ì¡´ì²˜ëŸ¼ í•¨ì • ë§ì´ ì¶”ê°€
  if (stageIdx >= 6) {
    return trapLayouts[stageIdx].filter(t => !t.laser);
  }
  return trapLayouts[stageIdx].concat(
    stages[stageIdx]
      .filter(p => !p.isDoor)
      .map((p, i) => {
        if (i % 3 === 0) return { x: p.x + 10, y: p.y - 10, width: 30, height: 10 };
        if (i % 5 === 0) return { x: p.x + 5, y: p.y - 10, width: 30, height: 10, bounce: true };
        if (i % 7 === 0) return { x: p.x + 5, y: p.y - 10, width: 30, height: 10, teleport: { x: 100, y: 700 } };
        return null;
      })
      .filter(t => t !== null)
  );
}

function getBallsForStage(stageIdx) {
  return trapLayouts[stageIdx].filter(t => t.ball).map(t => ({
    ...t,
    cx: t.x,
    cy: t.y,
    cvx: t.vx,
    cvy: t.vy,
    timer: 0,
    active: false
  }));
}

// ìœ ë„íƒ„ ìƒíƒœ ê´€ë¦¬
function getMissilesForStage(stageIdx) {
  return (trapLayouts[stageIdx] || [])
    .filter(t => t.missile)
    .map(t => ({
      ...t,
      cx: t.x,
      cy: t.y,
      active: false,
      timer: 0
    }));
}

// ì‚¬ë¼ì§€ëŠ” ë°œíŒ ìƒíƒœ ê´€ë¦¬
let vanishStates = {};

function resetVanishStates() {
  vanishStates = {};
  const plats = stages[currentStage];
  plats.forEach((p, idx) => {
    if (p.vanish) vanishStates[idx] = { triggered: false, timer: 0, vanished: false };
  });
}

let platforms = stages[currentStage];
let traps = getTrapsForStage(currentStage);
let lasers = getLasersForStage(currentStage);
let balls = getBallsForStage(currentStage);
let missiles = getMissilesForStage(currentStage);
resetVanishStates();

// ì—´ì‡  ìƒíƒœ
let hasKey = false;

window.addEventListener('keydown', e => {
  if (!keys[e.code]) {
    if (e.code === 'Space') {
      if (gameClear) {
        currentStage = 0;
        gameClear = false;
        restart();
        return;
      }
      if (player.grounded) {
        player.vy = player.jumpPower;
        player.grounded = false;
        player.canDoubleJump = true;
      } else if (player.canDoubleJump) {
        player.vy = player.jumpPower;
        player.canDoubleJump = false;
      }
    }
  }
  keys[e.code] = true;
  if (gameOver && e.code === 'Space') restart();
});

window.addEventListener('keyup', e => keys[e.code] = false);

function restart() {
  // ëª¨ë“  ìŠ¤í…Œì´ì§€ì—ì„œ ì‹œì‘ ë°œíŒ ìœ„ì— í”Œë ˆì´ì–´ ìœ„ì¹˜ (í•¨ì •ê³¼ ê²¹ì¹˜ì§€ ì•ŠëŠ” ì•ˆì „í•œ ê³³)
  platforms = stages[currentStage];
  traps = getTrapsForStage(currentStage);
  lasers = getLasersForStage(currentStage);
  balls = getBallsForStage(currentStage);
  missiles = getMissilesForStage(currentStage);
  resetVanishStates();
  hasKey = false;

  // ì‹œì‘ ë°œíŒ(ì²« ë²ˆì§¸ ë°œíŒ) ìœ„ì—ì„œ, í•´ë‹¹ ë°œíŒê³¼ ê²¹ì¹˜ëŠ” í•¨ì •ì´ ì—†ëŠ” ìœ„ì¹˜ë¥¼ ì°¾ìŒ
  const plat = platforms[0];
  let safeX = plat.x + plat.width / 2 - player.width / 2;
  let safeY = plat.y - player.height;

  // í•¨ì •ê³¼ ê²¹ì¹˜ì§€ ì•ŠëŠ” ì•ˆì „í•œ xì¢Œí‘œ ì°¾ê¸° (ì¢Œìš°ë¡œ 1í”½ì…€ì”© ì´ë™í•˜ë©° ê²€ì‚¬)
  let foundSafe = false;
  for (let dx = 0; dx <= plat.width - player.width; dx++) {
    let testX = plat.x + dx;
    let overlap = traps.some(t =>
      testX < t.x + t.width &&
      testX + player.width > t.x &&
      safeY < t.y + t.height &&
      safeY + player.height > t.y
    );
    if (!overlap) {
      safeX = testX;
      foundSafe = true;
      break;
    }
  }
  // í˜¹ì‹œ ëª» ì°¾ìœ¼ë©´ ì¤‘ì•™ì— ë‘ 
  player.x = safeX;
  player.y = safeY;
  player.vx = 0;
  player.vy = 0;
  player.canDoubleJump = false;
  player.hasJumped = false;
  gameOver = false;
  gameClear = false;
  drawInfo();
}

function nextStage() {
  currentStage++;
  if (currentStage >= stages.length) {
    gameClear = true;
    drawInfo();
    return;
  }
  platforms = stages[currentStage];
  traps = getTrapsForStage(currentStage);
  lasers = getLasersForStage(currentStage);
  balls = getBallsForStage(currentStage);
  missiles = getMissilesForStage(currentStage);
  resetVanishStates();
  hasKey = false;
  restart();
}

// ë ˆì´ì € ì—…ë°ì´íŠ¸ ë° ì¶©ëŒ ì²´í¬
function updateLasers() {
  for (let laser of lasers) {
    laser.timer = (laser.timer + 1) % laser.interval;
    laser.active = laser.timer < laser.duration;
    if (laser.active) {
      // ì¶©ëŒ ì²´í¬
      if (laser.direction === 'horizontal') {
        if (
          player.y + player.height > laser.y - 3 &&
          player.y < laser.y + 3 &&
          player.x + player.width > laser.x &&
          player.x < laser.x + laser.length
        ) {
          gameOver = true;
          deathCount++;
          drawInfo();
        }
      } else if (laser.direction === 'vertical') {
        if (
          player.x + player.width > laser.x - 3 &&
          player.x < laser.x + 3 &&
          player.y + player.height > laser.y &&
          player.y < laser.y + laser.length
        ) {
          gameOver = true;
          deathCount++;
          drawInfo();
        }
      }
    }
  }
}

// êµ¬ë¥´ëŠ” ê³µ ì—…ë°ì´íŠ¸ ë° ì¶©ëŒ ì²´í¬
function updateBalls() {
  for (let ball of balls) {
    ball.timer++;
    // intervalë§ˆë‹¤ delay í›„ì— ê³µì´ ë‹¤ì‹œ ì‹œì‘ì ì—ì„œ ì¶œë°œ
    if (ball.timer >= (ball.interval + (ball.delay || 0))) {
      ball.cx = ball.x;
      ball.cy = ball.y;
      ball.cvx = ball.vx;
      ball.cvy = ball.vy;
      ball.timer = 0;
      ball.active = true;
    }
    // delay ë™ì•ˆì€ ë¹„í™œì„±
    if (ball.timer < (ball.delay || 0)) {
      ball.active = false;
      continue;
    }
    ball.active = true;
    // ì¤‘ë ¥ ì ìš©
    if (ball.bouncy) {
      ball.cvy += 0.45;
    } else {
      ball.cvy += 0.5;
    }
    ball.cx += ball.cvx;
    ball.cy += ball.cvy;
    // ë°”ë‹¥/ë°œíŒ ì¶©ëŒ
    let onPlatform = false;
    for (let i = 0; i < platforms.length; i++) {
      const p = platforms[i];
      if (p.vanish && vanishStates[i] && vanishStates[i].vanished) continue;
      if (
        ball.cx + ball.radius > p.x &&
        ball.cx - ball.radius < p.x + p.width &&
        ball.cy + ball.radius > p.y &&
        ball.cy + ball.radius < p.y + p.height + 6 &&
        ball.cvy >= 0
      ) {
        ball.cy = p.y - ball.radius;
        if (ball.bouncy) {
          ball.cvy = -Math.abs(ball.cvy) * 0.85 - 6.5; // íŠ€ëŠ” íš¨ê³¼
        } else {
          ball.cvy = 0;
        }
        onPlatform = true;
      }
    }
    // ë°”ë‹¥ì— ë‹¿ìœ¼ë©´
    if (ball.cy + ball.radius > canvas.height) {
      ball.cy = canvas.height - ball.radius;
      if (ball.bouncy) {
        ball.cvy = -Math.abs(ball.cvy) * 0.85 - 6.5;
      } else {
        ball.cvy = 0;
        ball.cvx = 0;
        ball.active = false;
      }
    }
    // ë²½ ë°˜ì‚¬
    if (ball.cx - ball.radius < 0) {
      ball.cx = ball.radius;
      ball.cvx *= -1;
    }
    if (ball.cx + ball.radius > canvas.width) {
      ball.cx = canvas.width - ball.radius;
      ball.cvx *= -1;
    }
    // í”Œë ˆì´ì–´ ì¶©ëŒ
    if (
      ball.active &&
      player.x + player.width > ball.cx - ball.radius &&
      player.x < ball.cx + ball.radius &&
      player.y + player.height > ball.cy - ball.radius &&
      player.y < ball.cy + ball.radius
    ) {
      gameOver = true;
      deathCount++;
      drawInfo();
    }
  }
}

function updateMissiles() {
  for (let missile of missiles) {
    missile.timer++;
    // ì¿¨ë‹¤ìš´+delayë§ˆë‹¤ ë¯¸ì‚¬ì¼ ì¬ìƒì„±
    if (!missile.active && missile.timer >= (missile.cooldown + (missile.delay || 0))) {
      missile.cx = missile.x;
      missile.cy = missile.y;
      missile.active = true;
      missile.timer = 0;
      missile.life = 240; // ë¯¸ì‚¬ì¼ ìˆ˜ëª…(í”„ë ˆì„ ë‹¨ìœ„, ì˜ˆ: 4ì´ˆ)
    }
    if (!missile.active && missile.timer < (missile.delay || 0)) continue;
    if (!missile.active) continue;

    // ìˆ˜ëª… ê°ì†Œ ë° ë§Œë£Œì‹œ ë¹„í™œì„±í™”
    if (missile.life !== undefined) {
      missile.life--;
      if (missile.life <= 0) {
        missile.active = false;
        missile.timer = 0;
        continue;
      }
    }

    // í”Œë ˆì´ì–´ ë°©í–¥ìœ¼ë¡œ ì†ë„ ê³„ì‚°
    let dx = player.x + player.width / 2 - missile.cx;
    let dy = player.y + player.height / 2 - missile.cy;
    let dist = Math.sqrt(dx * dx + dy * dy);

    // ë¯¸ì‚¬ì¼ì´ í”Œë ˆì´ì–´ì™€ 350px ì´ìƒ ë©€ì–´ì§€ë©´ ë¹„í™œì„±í™”
    if (dist > 350) {
      missile.active = false;
      missile.timer = 0;
      continue;
    }

    if (dist > 0) {
      missile.cx += (dx / dist) * missile.speed;
      missile.cy += (dy / dist) * missile.speed;
    }

    // ë²½/ë°”ë‹¥ì— ë‹¿ìœ¼ë©´ ë¹„í™œì„±í™”
    if (
      missile.cx < 0 || missile.cx > canvas.width ||
      missile.cy < 0 || missile.cy > canvas.height
    ) {
      missile.active = false;
      missile.timer = 0;
      continue;
    }

    // í”Œë ˆì´ì–´ ì¶©ëŒ
    if (
      missile.active &&
      player.x + player.width > missile.cx - 12 &&
      player.x < missile.cx + 12 &&
      player.y + player.height > missile.cy - 12 &&
      player.y < missile.cy + 12
    ) {
      gameOver = true;
      deathCount++;
      drawInfo();
    }
  }
}

function updateVanishPlatforms() {
  // vanishStates: { idx: {triggered, timer, vanished} }
  for (const idx in vanishStates) {
    const state = vanishStates[idx];
    if (state.triggered && !state.vanished) {
      state.timer++;
      if (state.timer > 45) { // 45í”„ë ˆì„(ì•½ 0.75ì´ˆ) í›„ ì‚¬ë¼ì§
        state.vanished = true;
      }
    }
  }
}

function update() {
  if (gameOver || gameClear) return;

  if (keys['ArrowLeft']) player.vx = -3;
  else if (keys['ArrowRight']) player.vx = 3;
  else player.vx = 0;

  player.vy += gravity;
  player.x += player.vx;
  player.y += player.vy;

  player.grounded = false;
  for (let i = 0; i < platforms.length; i++) {
    const p = platforms[i];
    // ì‚¬ë¼ì§„ ë°œíŒì€ ì¶©ëŒ íŒì •ì—ì„œ ì œì™¸
    if (p.vanish && vanishStates[i] && vanishStates[i].vanished) continue;
    if (
      player.x < p.x + p.width &&
      player.x + player.width > p.x &&
      player.y + player.height > p.y &&
      player.y + player.height < p.y + p.height + 5 &&
      player.vy >= 0
    ) {
      player.y = p.y - player.height;
      player.vy = 0;
      player.grounded = true;
      player.canDoubleJump = false;
    }
  }

  if (player.grounded) player.canDoubleJump = true;

  if (player.x < 0) player.x = 0;
  if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
  if (player.y > canvas.height) {
    gameOver = true;
    deathCount++;
    drawInfo();
  }

  for (let p of platforms) {
    if (p.isDoor &&
      player.x < p.x + p.width &&
      player.x + player.width > p.x &&
      player.y < p.y + p.height &&
      player.y + player.height > p.y
    ) {
      nextStage();
    }
  }

  for (let t of traps) {
    if (
      player.x < t.x + t.width &&
      player.x + player.width > t.x &&
      player.y < t.y + t.height &&
      player.y + player.height > t.y
    ) {
      if (t.teleport) {
        player.x = t.teleport.x;
        player.y = t.teleport.y;
      } else if (t.teleportToStart) {
        currentStage = 0;
        deathCount++;
        restart();
        drawInfo();
        return;
      } else if (t.bounce) {
        player.vy = -15;
      } else {
        gameOver = true;
        deathCount++;
        drawInfo();
      }
    }
  }

  updateLasers();
  updateBalls();
  updateMissiles();
  updateVanishPlatforms();

  // ì‚¬ë¼ì§€ëŠ” ë°œíŒ ì²˜ë¦¬
  if (currentStage === 10) { // 11ìŠ¤í…Œì´ì§€(0-based)
    platforms.forEach((p, idx) => {
      // ì´ë¯¸ ì‚¬ë¼ì§„ ë°œíŒì€ íŠ¸ë¦¬ê±°ë„ ë¬´ì‹œ
      if (p.vanish && vanishStates[idx] && !vanishStates[idx].vanished) {
        // í”Œë ˆì´ì–´ê°€ ë°Ÿìœ¼ë©´ íƒ€ì´ë¨¸ ì‹œì‘
        if (
          player.x + player.width > p.x &&
          player.x < p.x + p.width &&
          player.y + player.height > p.y - 2 &&
          player.y + player.height < p.y + p.height + 5 &&
          player.vy >= 0
        ) {
          vanishStates[idx].triggered = true;
        }
      }
    });
  }

  // 13ìŠ¤í…Œì´ì§€: ì—´ì‡  íšë“/ë¬¸ ì—´ê¸°/ë²½ ë§‰í˜
  if (currentStage === 12) {
    // ì—´ì‡  íšë“
    const key = platforms.key;
    if (
      key &&
      !hasKey &&
      player.x + player.width > key.x &&
      player.x < key.x + key.width &&
      player.y + player.height > key.y &&
      player.y < key.y + key.height
    ) {
      hasKey = true;
    }
    // ë²½ ì¶©ëŒ(ë§‰í˜)
    for (let p of platforms) {
      if (p.isWall &&
        player.x < p.x + p.width &&
        player.x + player.width > p.x &&
        player.y < p.y + p.height &&
        player.y + player.height > p.y
      ) {
        // ê°„ë‹¨í•˜ê²Œ íŠ•ê²¨ëƒ„
        if (player.x + player.width / 2 < p.x + p.width / 2) player.x = p.x - player.width;
        else player.x = p.x + p.width;
      }
    }
    // ì—´ì‡ ë¬¸(ë¬¸)ì€ ì—´ì‡  ì—†ìœ¼ë©´ í†µê³¼ ë¶ˆê°€
    for (let p of platforms) {
      if (p.isDoor && p.isKeyDoor) {
        if (
          player.x < p.x + p.width &&
          player.x + player.width > p.x &&
          player.y < p.y + p.height &&
          player.y + player.height > p.y
        ) {
          if (hasKey) {
            nextStage();
          } else {
            // ë¬¸ì— ë§‰í˜
            if (player.x + player.width / 2 < p.x + p.width / 2) player.x = p.x - player.width;
            else player.x = p.x + p.width;
          }
        }
      }
    }
  }
}

// ê²Œì„ ì„¤ëª…/ìƒíƒœ í‘œì‹œ í•¨ìˆ˜
function drawInfo() {
  const info = document.getElementById('info');
  info.innerHTML = `
    <div style="font-size:20px;font-weight:bold;margin-bottom:10px;">ê²Œì„ ì„¤ëª…</div>
    <div class="desc-row"><span class="color-box" style="background:green"></span> <b>ì´ˆë¡</b>: ì¼ë°˜ ë°œíŒ</div>
    <div class="desc-row"><span class="color-box" style="background:blue"></span> <b>íŒŒë‘</b>: ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ë¬¸</div>
    <div class="desc-row"><span class="color-box" style="background:purple"></span> <b>ë³´ë¼</b>: ì¼ë°˜ í•¨ì • (ì¦‰ì‚¬)</div>
    <div class="desc-row"><span class="color-box" style="background:yellow"></span> <b>ë…¸ë‘</b>: ì í”„ í•¨ì • (ë†’ì´ íŠ)</div>
    <div class="desc-row"><span class="color-box" style="background:cyan"></span> <b>í•˜ëŠ˜</b>: ìˆœê°„ì´ë™ í•¨ì •</div>
    <div class="desc-row"><span class="color-box" style="background:orange"></span> <b>ì£¼í™©</b>: ì²˜ìŒìœ¼ë¡œ ìˆœê°„ì´ë™</div>
    <div class="desc-row"><span class="color-box" style="background:red"></span> <b>ë¹¨ê°•ì„ </b>: ë ˆì´ì €(ì£¼ê¸°ì ìœ¼ë¡œ ë°œì‚¬, ë‹¿ìœ¼ë©´ ì¦‰ì‚¬)</div>
    <div class="desc-row"><span class="color-box" style="background:#444"></span> <b>ê²€ì€ê³µ</b>: êµ¬ë¥´ëŠ” ê³µ(ë‹¿ìœ¼ë©´ ì¦‰ì‚¬)</div>
    <div class="desc-row"><span class="color-box" style="background:#e06"></span> <b>í•‘í¬ê³µ</b>: íŠ€ëŠ” ê³µ(ë‹¿ìœ¼ë©´ ì¦‰ì‚¬)</div>
    <div class="desc-row"><span class="color-box" style="background:#bbb"></span> <b>íšŒìƒ‰</b>: ë°Ÿìœ¼ë©´ ì ì‹œ í›„ ì‚¬ë¼ì§€ëŠ” ë°œíŒ</div>
    <div class="desc-row"><span class="color-box" style="background:#e22"></span> <b>ë¹¨ê°„ì›</b>: ìœ ë„ ë¯¸ì‚¬ì¼(í”Œë ˆì´ì–´ë¥¼ ë”°ë¼ì˜´)</div>
    <div class="desc-row"><span class="color-box" style="background:gold"></span> <b>ì—´ì‡ </b>: ë¨¹ìœ¼ë©´ ì—´ì‡ ë¬¸ í†µê³¼ ê°€ëŠ¥</div>
    <div class="desc-row"><span class="color-box" style="background:#888"></span> <b>íšŒìƒ‰ë²½</b>: í†µê³¼ ë¶ˆê°€</div>
    <hr>
    <div class="desc-row"><b>ìŠ¤í…Œì´ì§€</b>: ${currentStage+1} / ${stages.length}</div>
    <div class="desc-row"><b>ì£½ì€ íšŸìˆ˜</b>: ${deathCount}</div>
    ${currentStage === 12 ? `<div class="desc-row"><b>ì—´ì‡ </b>: ${hasKey ? 'íšë“' : 'ë¯¸íšë“'}</div>` : ''}
  `;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = player.color;
  ctx.fillRect(player.x, player.y, player.width, player.height);

  // ë°œíŒ ê·¸ë¦¬ê¸°
  platforms.forEach((p, idx) => {
    if (p.vanish) {
      // ì‚¬ë¼ì§„ ë°œíŒì€ ê·¸ë¦¬ì§€ ì•ŠìŒ
      if (vanishStates[idx] && vanishStates[idx].vanished) return;
      // ì‚¬ë¼ì§€ê¸° ì§ì „ì´ë©´ ê¹œë¹¡ì„
      if (vanishStates[idx] && vanishStates[idx].triggered && vanishStates[idx].timer > 30) {
        ctx.globalAlpha = (Math.floor(performance.now() / 100) % 2) ? 0.3 : 0.8;
      } else {
        ctx.globalAlpha = 1;
      }
      ctx.fillStyle = '#bbb';
      ctx.fillRect(p.x, p.y, p.width, p.height);
      ctx.globalAlpha = 1;
    } else if (p.isWall) {
      ctx.fillStyle = '#333';
      ctx.fillRect(p.x, p.y, p.width, p.height);
    } else if (p.isDoor && p.isKeyDoor) {
      ctx.fillStyle = hasKey ? '#1e90ff' : '#888';
      ctx.fillRect(p.x, p.y, p.width, p.height);
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.strokeRect(p.x, p.y, p.width, p.height);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 16px Arial';
      ctx.fillText('ğŸ”‘', p.x + p.width / 2 - 8, p.y + 16);
    } else {
      ctx.fillStyle = p.isDoor ? 'blue' : 'green';
      ctx.fillRect(p.x, p.y, p.width, p.height);
    }
  });

  // ì—´ì‡  ê·¸ë¦¬ê¸°(13ìŠ¤í…Œì´ì§€)
  if (currentStage === 12 && platforms.key && !hasKey) {
    const key = platforms.key;
    ctx.save();
    ctx.fillStyle = 'gold';
    ctx.strokeStyle = '#b88d00';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(key.x + key.width / 2, key.y + key.height / 2, 10, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    ctx.font = 'bold 18px Arial';
    ctx.fillStyle = '#b88d00';
    ctx.fillText('ğŸ”‘', key.x + 2, key.y + 18);
    ctx.restore();
  }

  for (let t of traps) {
    if (t.teleportToStart) ctx.fillStyle = 'orange';
    else if (t.teleport) ctx.fillStyle = 'cyan';
    else if (t.bounce) ctx.fillStyle = 'yellow';
    else ctx.fillStyle = 'purple';
    ctx.fillRect(t.x, t.y, t.width, t.height);
  }

  // ë ˆì´ì € ê·¸ë¦¬ê¸°
  for (let laser of lasers) {
    if (laser.active) {
      ctx.save();
      ctx.globalAlpha = 0.85;
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 6;
      ctx.beginPath();
      if (laser.direction === 'horizontal') {
        ctx.moveTo(laser.x, laser.y);
        ctx.lineTo(laser.x + laser.length, laser.y);
      } else {
        ctx.moveTo(laser.x, laser.y);
        ctx.lineTo(laser.x, laser.y + laser.length);
      }
      ctx.stroke();
      ctx.restore();
    } else {
      // ë¹„í™œì„±í™”ì‹œ íë¦¿í•˜ê²Œ í‘œì‹œ(ì˜ˆê³ )
      ctx.save();
      ctx.globalAlpha = 0.25;
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 3;
      ctx.beginPath();
      if (laser.direction === 'horizontal') {
        ctx.moveTo(laser.x, laser.y);
        ctx.lineTo(laser.x + laser.length, laser.y);
      } else {
        ctx.moveTo(laser.x, laser.y);
        ctx.lineTo(laser.x, laser.y + laser.length);
      }
      ctx.stroke();
      ctx.restore();
    }
  }

  // êµ¬ë¥´ëŠ” ê³µ ê·¸ë¦¬ê¸°
  for (let ball of balls) {
    if (ball.active) {
      ctx.save();
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = ball.color || '#444';
      ctx.beginPath();
      ctx.arc(ball.cx, ball.cy, ball.radius, 0, Math.PI * 2);
      ctx.fill();
      ctx.lineWidth = 3;
      ctx.strokeStyle = ball.color ? '#a04' : '#222';
      ctx.stroke();
      ctx.restore();
    }
  }

  // ìœ ë„íƒ„(ë¯¸ì‚¬ì¼) ê·¸ë¦¬ê¸°
  for (let missile of missiles) {
    if (missile.active) {
      ctx.save();
      ctx.globalAlpha = 0.95;
      ctx.fillStyle = '#e22';
      ctx.beginPath();
      ctx.arc(missile.cx, missile.cy, 12, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#900';
      ctx.lineWidth = 2;
      ctx.stroke();
      // ë¯¸ì‚¬ì¼ ì•ë¶€ë¶„(í”Œë ˆì´ì–´ ë°©í–¥) í‘œì‹œ
      let dx = player.x + player.width / 2 - missile.cx;
      let dy = player.y + player.height / 2 - missile.cy;
      let dist = Math.sqrt(dx * dx + dy * dy);
      if (dist > 0) {
        ctx.save();
        ctx.translate(missile.cx, missile.cy);
        ctx.rotate(Math.atan2(dy, dx));
        ctx.fillStyle = '#fff';
        ctx.fillRect(8, -3, 8, 6);
        ctx.restore();
      }
      ctx.restore();
    }
  }

  if (gameOver) {
    ctx.fillStyle = 'black';
    ctx.font = '30px Arial';
    ctx.fillText('ì£½ì—ˆë‹¤! ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì¬ì‹œì‘', 20, canvas.height / 2);
  } else if (gameClear) {
    ctx.fillStyle = 'black';
    ctx.font = '30px Arial';
    ctx.fillText('í´ë¦¬ì–´! ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ë‹¤ì‹œ ì‹œì‘', 20, canvas.height / 2);
  }
}

document.getElementById('skipStageBtn').onclick = function() {
  if (!gameClear && !gameOver && currentStage < stages.length - 1) {
    nextStage();
  }
};

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

drawInfo();
loop();
</script>
</body>
</html>

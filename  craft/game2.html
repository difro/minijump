<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Î≥¥Î¨ºÏ∞æÍ∏∞ Í≤åÏûÑ</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    body {
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
    }
    #board {
      display: grid;
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 2px;
      margin: 0;
      z-index: 1;
    }
    .cell {
      width: 100%;
      height: 100%;
      background: #bde0fe;
      border: 1px solid #90caf9;
      cursor: pointer;
      text-align: center;
      font-size: 2.5vw;
      line-height: 1;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      transition: background 0.1s;
    }
    .found {
      background: gold;
      color: #333;
      font-weight: bold;
    }
    .player {
      background: #90caf9;
      font-weight: bold;
    }
    .treasure {
      background: gold;
    }
    .wall {
      background: #888;
      color: #fff;
      font-weight: bold;
    }
    .tree {
      background: #388e3c;
      color: #fff;
      font-weight: bold;
    }
    .key {
      background: #ffd700;
      color: #333;
      font-weight: bold;
    }
    .lock {
      background: #555;
      color: #fff;
      font-weight: bold;
    }
    #message {
      position: absolute;
      top: 10px;
      left: 0;
      width: 100vw;
      text-align: center;
      font-size: 2vw;
      z-index: 2;
      pointer-events: none;
      color: #222;
      text-shadow: 1px 1px 4px #fff, 0 0 2px #90caf9;
    }
    h2 {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Î≥¥Î¨ºÏ∞æÍ∏∞ Í≤åÏûÑ</h2>
  <div id="board"></div>
  <div id="message"></div>
  <script>
    // Ïä§ÌÖåÏù¥ÏßÄÎ≥Ñ Î≥¥Îìú ÌÅ¨Í∏∞ Î∞è Îßµ Ï†ïÏùò
    const stageConfigs = [
      // stage 1 (ÏôÑÏ†ÑÌïú ÌÜµÎ°ú Î≥¥Ïû•)
      {
        size: 10,
        map: [
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall'],
          ['wall',null,null,null,null,null,null,null,null,'wall'],
          ['wall','wall','wall','wall','wall','wall','wall','wall',null,'wall'],
          ['wall',null,null,null,null,null,null,'wall',null,'wall'],
          ['wall',null,'wall','wall','wall','wall',null,'wall',null,'wall'],
          ['wall',null,'wall',null,null,'wall',null,'wall',null,'wall'],
          ['wall',null,'wall',null,'wall','wall',null,'wall',null,'wall'],
          ['wall',null,'wall',null,'wall',null,null,null,null,'wall'],
          ['wall',null,null,null,'wall','wall','wall','wall',null,'wall'],
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall'],
        ],
        player: {x: 1, y: 1},
        treasure: {x: 8, y: 8},
        key: null,
        lasers: [
          {type: 'H', y: 5}
        ],
        switchPos: null
      },
      // stage 2 (Í≤ΩÎ°ú Î≥¥Ïû•)
      {
        size: 12,
        map: [
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall'],
          ['wall',null,null,null,'wall',null,null,'tree',null,null,'tree','wall'],
          ['wall',null,'tree',null,null,null,'tree','wall',null,'tree',null,'wall'],
          ['wall',null,null,null,'wall',null,null,null,null,null,null,'wall'],
          ['wall','tree','wall',null,'tree',null,'wall','tree','tree',null,null,'wall'],
          ['wall',null,'wall',null,'wall',null,null,null,'wall',null,null,'wall'],
          ['wall',null,'wall',null,'wall',null,'wall',null,'wall',null,'tree','wall'],
          ['wall',null,null,null,null,null,null,null,null,null,null,'wall'],
          ['wall','tree','wall','tree','tree',null,'wall','tree','tree','tree',null,'wall'],
          ['wall',null,'wall',null,'wall',null,'wall',null,'wall',null,null,'wall'],
          ['wall',null,null,null,null,null,null,null,null,null,null,'wall'],
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall'],
        ],
        player: {x: 1, y: 1},
        treasure: {x: 10, y: 10},
        key: {x: 5, y: 9},
        lasers: [
          {type: 'H', y: 7}
        ],
        switchPos: null
      },
      // stage 3 (Í≤ΩÎ°ú Î≥¥Ïû•)
      {
        size: 14,
        map: [
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall'],
          ['wall',null,null,null,null,null,null,null,null,null,null,null,null,'wall'],
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall',null,'wall','wall'],
          ['wall',null,null,null,null,null,null,null,null,null,'wall',null,null,'wall'],
          ['wall',null,'wall','wall','wall','wall','wall','wall','wall',null,'wall','wall',null,'wall'],
          ['wall',null,'wall',null,null,null,null,null,'wall',null,null,null,null,'wall'],
          ['wall',null,'wall',null,'wall','wall','wall',null,'wall','wall','wall','wall',null,'wall'],
          ['wall',null,'wall',null,'wall',null,null,null,null,null,null,'wall',null,'wall'],
          ['wall',null,'wall',null,'wall',null,'wall','wall','wall','wall',null,'wall',null,'wall'],
          ['wall',null,'wall',null,'wall',null,'wall',null,null,'wall',null,'wall',null,'wall'],
          ['wall',null,'wall',null,'wall',null,'wall',null,'wall','wall',null,'wall',null,'wall'],
          ['wall',null,null,null,'wall',null,null,null,'wall',null,null,null,null,'wall'],
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall'],
          ['wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall','wall'],
        ],
        player: {x: 1, y: 1},
        switchPos: {x: 11, y: 3},
        key: {x: 11, y: 5},
        treasure: {x: 11, y: 11},
        lasers: [
          {type: 'H', y: 8}
        ]
      }
    ];

    let stage = 1;
    let hasKey = false;
    let keyX = null, keyY = null;
    let switchX = null, switchY = null;
    let laserActive = true;
    let quizA = 0, quizB = 0;

    let size, map, playerX, playerY, treasureX, treasureY, found, cells;
    let lasers = [];

    function startStage(stageNum = 1) {
      stage = stageNum;
      hasKey = false;
      found = false;
      keyX = keyY = null;
      lasers = [];
      switchX = switchY = null;
      laserActive = true;

      // Ïä§ÌÖåÏù¥ÏßÄ Íµ¨ÏÑ± Î∂àÎü¨Ïò§Í∏∞
      const config = stageConfigs[stage-1];
      size = config.size;
      // ÍπäÏùÄ Î≥µÏÇ¨
      map = config.map.map(row => row.slice());
      playerX = config.player.x; playerY = config.player.y;
      treasureX = config.treasure.x; treasureY = config.treasure.y;
      if (config.key) {
        keyX = config.key.x; keyY = config.key.y;
      }
      if (stage === 3) {
        lasers = config.lasers.map(l => ({...l}));
        switchX = config.switchPos.x; switchY = config.switchPos.y;
        // Î†àÏù¥Ï†ÄÎ•º ÎßµÏóê ÌëúÏãú
        for (const laser of lasers) {
          if (laser.type === 'H') {
            for (let x = 0; x < size; x++) {
              if (
                (playerY === laser.y && playerX === x) ||
                (treasureY === laser.y && treasureX === x) ||
                (keyY === laser.y && keyX === x) ||
                (switchY === laser.y && switchX === x)
              ) continue;
              map[laser.y][x] = 'laserH';
            }
          } else {
            for (let y = 0; y < size; y++) {
              if (
                (playerX === laser.x && playerY === y) ||
                (treasureX === laser.x && treasureY === y) ||
                (keyX === laser.x && keyY === y) ||
                (switchX === laser.x && switchY === y)
              ) continue;
              map[y][laser.x] = 'laserV';
            }
          }
        }
      }

      // Î≥¥Îìú Í∑∏Î¶¨Îìú ÎèôÏ†Å ÏÑ§Ï†ï
      board.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      board.style.gridTemplateRows = `repeat(${size}, 1fr)`;

      // ÏÖÄ ÏÉùÏÑ±
      board.innerHTML = '';
      cells = [];
      for (let y = 0; y < size; y++) {
        cells[y] = [];
        for (let x = 0; x < size; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.x = x;
          cell.dataset.y = y;
          cells[y][x] = cell;
          board.appendChild(cell);
        }
      }
      render();
      message.textContent = `Ïä§ÌÖåÏù¥ÏßÄ ${stage}`;
    }

    function resizeCells() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      const cellSize = Math.min(w, h) / size;
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const cell = cells[y][x];
          cell.style.fontSize = (cellSize * 0.7) + 'px';
        }
      }
    }

    function render() {
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const cell = cells[y][x];
          cell.className = 'cell';
          cell.textContent = '';
          if (map[y][x] === 'wall') {
            cell.classList.add('wall');
            cell.textContent = 'üß±';
            continue;
          }
          if (map[y][x] === 'tree') {
            cell.classList.add('tree');
            cell.textContent = 'üå≥';
            continue;
          }
          if (stage === 3 && map[y][x] === 'laserH') {
            cell.classList.add('lock');
            cell.textContent = laserActive ? 'üî¥' : '‚ö™Ô∏è';
            continue;
          }
          if (stage === 3 && map[y][x] === 'laserV') {
            cell.classList.add('lock');
            cell.textContent = laserActive ? 'üîµ' : '‚ö™Ô∏è';
            continue;
          }
          if (stage === 3 && x === switchX && y === switchY && laserActive) {
            cell.classList.add('key');
            cell.textContent = 'üü¢';
            continue;
          }
          if (stage >= 2 && !hasKey && x === keyX && y === keyY) {
            cell.classList.add('key');
            cell.textContent = 'üîë';
            continue;
          }
          if (x === treasureX && y === treasureY && !found) {
            if (stage === 3 && laserActive) {
              cell.classList.add('lock');
              cell.textContent = 'üîí';
            } else if (stage >= 2 && !hasKey) {
              cell.classList.add('lock');
              cell.textContent = 'üîí';
            } else {
              cell.classList.add('treasure');
              cell.textContent = 'üíé';
            }
          }
          if (x === playerX && y === playerY) {
            cell.classList.add('player');
            cell.textContent = 'üßë‚ÄçüöÄ';
          }
          if (found && x === treasureX && y === treasureY) {
            cell.classList.add('found');
            cell.textContent = 'üíé';
          }
        }
      }
      resizeCells();
    }

    function checkTreasure() {
      if (playerX === treasureX && playerY === treasureY) {
        if (stage === 3 && laserActive) {
          message.textContent = 'Î†àÏù¥Ï†Ä Î≥¥ÏïàÏù¥ ÏûëÎèô Ï§ëÏûÖÎãàÎã§!';
          return;
        }
        if (stage >= 2 && !hasKey) {
          message.textContent = 'Ïó¥Ïá†Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§!';
          return;
        }
        found = true;
        if (stage === 1) {
          message.textContent = 'Ï∂ïÌïòÌï©ÎãàÎã§! Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§!';
          render();
          setTimeout(() => {
            startStage(2);
          }, 1200);
        } else if (stage === 2) {
          message.textContent = 'Ï∂ïÌïòÌï©ÎãàÎã§! ÎßàÏßÄÎßâ Ïä§ÌÖåÏù¥ÏßÄÎ°ú!';
          render();
          setTimeout(() => {
            startStage(3);
          }, 1200);
        } else {
          message.textContent = 'Ï∂ïÌïòÌï©ÎãàÎã§! Î™®Îì† Î≥¥Î¨ºÏùÑ Ï∞æÏïòÏäµÎãàÎã§!';
          render();
        }
      }
    }

    function checkKey() {
      if (stage >= 2 && !hasKey && playerX === keyX && playerY === keyY) {
        hasKey = true;
        message.textContent = 'Ïó¥Ïá†Î•º ÏñªÏóàÏäµÎãàÎã§! Ïù¥Ï†ú Î≥¥Î¨ºÏùÑ ÏñªÏùÑ Ïàò ÏûàÏäµÎãàÎã§.';
        render();
        setTimeout(() => { message.textContent = `Ïä§ÌÖåÏù¥ÏßÄ ${stage}`; }, 1000);
      }
    }

    function checkSwitch() {
      if (
        stage === 3 &&
        laserActive &&
        playerX === switchX &&
        playerY === switchY
      ) {
        quizA = Math.floor(Math.random() * 50) + 10;
        quizB = Math.floor(Math.random() * 50) + 10;
        setTimeout(() => {
          let answer = prompt(`Ïä§ÏúÑÏπòÎ•º ÏûëÎèôÌïòÎ†§Î©¥ Î¨∏Ï†úÎ•º Ìë∏ÏÑ∏Ïöî: ${quizA} + ${quizB} = ?`);
          if (answer !== null && parseInt(answer, 10) === quizA + quizB) {
            laserActive = false;
            message.textContent = 'Ï†ïÎãµ! Î†àÏù¥Ï†ÄÍ∞Ä Í∫ºÏ°åÏäµÎãàÎã§!';
            render();
            setTimeout(() => { message.textContent = `Ïä§ÌÖåÏù¥ÏßÄ ${stage}`; }, 1000);
          } else {
            message.textContent = 'Ïò§ÎãµÏûÖÎãàÎã§! Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
            render();
            setTimeout(() => { message.textContent = `Ïä§ÌÖåÏù¥ÏßÄ ${stage}`; }, 1000);
          }
        }, 100);
      }
    }

    document.addEventListener('keydown', function(e) {
      if (found) return;
      let nx = playerX, ny = playerY;
      if (e.key === 'ArrowUp') ny--;
      if (e.key === 'ArrowDown') ny++;
      if (e.key === 'ArrowLeft') nx--;
      if (e.key === 'ArrowRight') nx++;
      if (
        nx >= 0 && nx < size &&
        ny >= 0 && ny < size &&
        map[ny][nx] !== 'wall' &&
        map[ny][nx] !== 'tree' &&
        (stage !== 3 || !laserActive || (map[ny][nx] !== 'laserH' && map[ny][nx] !== 'laserV'))
      ) {
        playerX = nx;
        playerY = ny;
        checkKey();
        checkSwitch();
        render();
        checkTreasure();
        e.preventDefault();
      }
    });

    window.addEventListener('resize', render);

    // Í≤åÏûÑ ÏãúÏûë
    startStage(1);
  </script>
</body>
</html>
